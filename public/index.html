<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolves Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .page {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .page.active {
      display: block;
    }

    .config-form {
      max-width: 500px;
    }

    .config-form input,
    .config-form select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .special-roles {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 10px 0;
    }

    .special-roles label {
      display: flex;
      align-items: center;
    }

    .special-roles input {
      width: auto;
      margin-right: 8px;
    }

    .special-wolves {
      margin: 10px 0 25px 0;
    }

    .special-wolves label {
      display: flex;
      align-items: center;
    }

    .special-wolves input {
      width: auto;
      margin: 0 8px;
    }

    .seating-area {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      max-width: 1000px;
      margin: 20px 0;
    }

    .seat {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .seat:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .seat.occupied {
      background-color: #28a745;
      color: white;
      cursor: not-allowed;
    }

    .seat.occupied:hover {
      background-color: #28a745;
    }

    .seat.disconnected {
      background-color: #ffc107;
      color: #856404;
      cursor: not-allowed;
      border: 2px dashed #856404;
    }

    .seat.disconnected:hover {
      background-color: #ffc107;
    }

    .seat.disconnected .seat-player::after {
      content: " (Disconnected)";
      font-size: 12px;
      font-style: italic;
    }

    /* Game phase seat states */
    .seat.selectable {
      border-color: #ffc107;
      background-color: #fff3cd;
      cursor: pointer;
    }

    .seat.selectable:hover {
      border-color: #ff8800;
      background-color: #ffe69c;
    }

    .seat.selected {
      border-color: #dc3545;
      background-color: #f8d7da;
      color: #721c24;
      font-weight: bold;
    }

    .seat.dead {
      background-color: #6c757d;
      color: white;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* Game phase UI */
    .game-status {
      background-color: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }

    .game-status.night {
      background-color: #1a1a2e;
      color: white;
    }

    .game-status.day {
      background-color: #fff3cd;
      color: #856404;
    }

    .phase-info {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .action-controls {
      margin: 20px 0;
      text-align: center;
    }

    .action-controls .button {
      margin: 5px;
    }

    .seat-number {
      font-weight: bold;
      font-size: 18px;
    }

    .seat-player {
      font-size: 14px;
      margin-top: 5px;
    }

    .button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .button:hover {
      background-color: #0056b3;
    }

    .button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .button.success {
      background-color: #28a745;
    }

    .button.success:hover {
      background-color: #218838;
    }

    .status {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .role-display {
      text-align: center;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .role-image {
      width: 200px;
      height: 200px;
      border-radius: 15px;
      border: 3px solid #007bff;
      object-fit: cover;
      margin: 20px auto;
      display: block;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }

    .role-image:hover {
      transform: scale(1.05);
    }

    .role-name {
      font-size: 36px;
      font-weight: bold;
      color: #007bff;
      margin: 20px 0;
    }

    .error {
      color: #dc3545;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .role-status {
      color: #6c757d;
    }

    .role-status.assigned {
      color: #28a745;
    }

    .game-page {
      text-align: center;
      padding: 20px;
    }

    .night-phase {
      background-color: #1a1a2e;
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .day-phase {
      background-color: #f8f9fa;
      color: #333;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .phase-message {
      font-size: 24px;
      font-weight: bold;
      margin: 20px 0;
    }

    .action-area {
      margin: 20px 0;
    }

    .player-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .player-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      color: #333;
    }

    .player-card:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .player-card.selected {
      border-color: #28a745;
      background-color: #d4edda;
    }

    .player-card.dead {
      background-color: #f8d7da;
      border-color: #dc3545;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .action-buttons {
      margin: 20px 0;
    }

    .action-buttons .button {
      margin: 0 10px;
    }

    .result-display {
      background-color: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Landing Page -->
  <div id="landing" class="page active">
    <h1>üê∫ Werewolves Game</h1>

    <div style="margin: 20px 0;">
      <h3>Join Game</h3>
      <input id="playerName" type="text" placeholder="Enter your name" maxlength="20">
      <input id="roomCode" type="text" placeholder="Enter room code" maxlength="6">
      <button class="button" onclick="joinGame()">Join Game</button>
    </div>

    <div style="margin: 20px 0;">
      <h3>Host Game</h3>
      <button class="button success" onclick="showConfigPage()">Configure & Create Game</button>
    </div>

    <div id="landingMessage"></div>
  </div>

  <!-- Configuration Page (Host Only) -->
  <div id="configure" class="page">
    <h2>‚öôÔ∏è Game Configuration</h2>

    <form class="config-form" onsubmit="configureGame(event)">
      <label>Game Language:</label>
      <select id="gameLanguage">
        <option value="en">English</option>
        <option value="zh">‰∏≠Êñá (Chinese)</option>
      </select>

      <label>Total Players:</label>
      <select id="totalPlayers" onchange="updateRoleInputs()">
        <option value="6">6 Players</option>
        <option value="7">7 Players</option>
        <option value="8">8 Players</option>
        <option value="9">9 Players</option>
        <option value="10">10 Players</option>
        <option value="11">11 Players</option>
        <option value="12" selected>12 Players</option>
        <option value="13">13 Players</option>
        <option value="14">14 Players</option>
        <option value="15">15 Players</option>
        <option value="16">16 Players</option>
      </select>

      <label>Number of Werewolves:</label>
      <input id="numWerewolves" type="number" min="0" max="4" value="3">

      <label>Special Wolves:</label>
      <div class="special-wolves">
        <label><input type="checkbox" value="whitewolf"> ‚ö™ White Wolf</label>
      </div>

      <label>Number of Villagers:</label>
      <input id="numVillagers" type="number" min="0" max="8" value="6">

      <label>Number of Orphans:</label>
      <input id="numOrphans" type="number" min="0" max="4" value="0">

      <label>Special Roles:</label>
      <div class="special-roles">
        <label><input type="checkbox" value="seer"> üîÆ Seer</label>
        <label><input type="checkbox" value="witch"> üßô‚Äç‚ôÄÔ∏è Witch</label>
        <label><input type="checkbox" value="hunter"> üèπ Hunter</label>
        <label><input type="checkbox" value="fool"> üÉè Fool</label>
        <label><input type="checkbox" value="guard"> üõ°Ô∏è Guard</label>
        <label><input type="checkbox" value="cupid"> üíò Cupid</label>
      </div>

      <div id="roleValidation" class="error" style="display: none;"></div>

      <button type="submit" class="button success">Create Room</button>
      <button type="button" class="button" onclick="showLandingPage()">Back</button>
    </form>
  </div>

  <!-- Game Lobby -->
  <div id="lobby" class="page">
    <h2>üè† Game Lobby</h2>

    <!-- Game Status (appears during game) -->
    <div id="gameStatus" class="game-status" style="display: none;">
      <div class="phase-info" id="phaseInfo">Game Starting...</div>
      <div id="phaseInstructions"></div>
    </div>

    <div id="gameInfo" class="status">
      <div><strong>Room Code:</strong> <span id="displayRoomCode"></span></div>
      <div><strong>Total Players:</strong> <span id="displayTotalPlayers"></span></div>
      <div><strong>Seated Players:</strong> <span id="seatedCount">0</span> / <span id="totalPlayerCount">0</span></div>
      <div><strong>Werewolves:</strong> <span id="displayWerewolves">0</span> | <strong>Villagers:</strong> <span
          id="displayVillagers">0</span> | <strong>Orphans:</strong> <span id="displayOrphans">0</span></div>
      <div><strong>Roles:</strong> <span id="roleStatusText" class="role-status">Not assigned</span></div>
    </div>

    <h3 id="lobbyTitle">Choose Your Seat</h3>
    <div id="seatingArea" class="seating-area">
      <!-- Seats will be dynamically generated -->
    </div>

    <!-- Game Phase Action Controls -->
    <div id="actionControls" class="action-controls" style="display: none;">
      <div id="actionMessage" style="margin-bottom: 15px; font-weight: bold;"></div>
      <button id="confirmSelection" class="button success" style="display: none;" onclick="confirmSelection()">Confirm
        Selection</button>
      <button id="seerContinueBtn" class="button success" style="display: none;" onclick="seerContinue()">Confirm &
        Continue</button>
      <button id="witchSaveBtn" class="button" style="display: none;" onclick="witchSave()">Save Player</button>
      <button id="witchPoisonBtn" class="button" style="display: none;" onclick="witchPoison()">Use Poison</button>
      <button id="witchSkipBtn" class="button" style="display: none;" onclick="skipWitchAction()">Skip</button>
      <button id="hunterContinueBtn" class="button success" style="display: none;" onclick="hunterContinue()">Confirm &
        Continue</button>
      <div id="actionResult" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
    </div>

    <div id="gameControls">
      <button id="startGameBtn" class="button success" onclick="startGame()" disabled>Start Game</button>
      <button id="shuffleRolesBtn" class="button" onclick="shuffleRoles()"
        style="display: none; background-color: #17a2b8;">üîÄ Shuffle Roles</button>
      <button id="seeRoleBtn" class="button" onclick="showRolePage()" style="display: none;">See Your Role</button>
      <button id="checkNightStatusBtn" class="button" onclick="checkLastNight()" style="display: none;">Check Last Night
        Status</button>
      <button id="viewOrphanMapBtn" class="button" onclick="viewOrphanMap()"
        style="background-color: #6f42c1; color: white;">üë∂ View Orphan Map</button>
      <button id="testAudioBtn" class="button" onclick="testAudio()" style="background-color: #ffc107; color: #000;">üîä
        Test Audio</button>
      <button class="button" onclick="showLandingPage()">Leave Game</button>
    </div>

    <div id="lobbyMessage"></div>
  </div>

  <!-- Role Page -->
  <div id="role" class="page">
    <div class="role-display">
      <h2>üé≠ Your Role</h2>
      <img id="roleImage" class="role-image" src="" alt="Role Image" style="display: none;">
      <div class="role-name" id="roleDisplay">Loading...</div>
      <div id="roleDescription"></div>
      <button class="button" onclick="showLobbyPage()">Back to Game</button>
    </div>
  </div>

  <!-- Game Page -->
  <div id="game" class="page">
    <div class="game-page">
      <h2>üéÆ Game in Progress</h2>

      <!-- Current Phase Display -->
      <div id="currentPhase" class="night-phase">
        <div class="phase-message" id="phaseMessage">Game Starting...</div>
      </div>

      <!-- Action Area (shown only to relevant roles during their turn) -->
      <div id="actionArea" class="action-area hidden">
        <!-- Player Selection -->
        <div id="playerSelection" class="hidden">
          <h3 id="actionTitle">Choose a player:</h3>
          <div id="playerList" class="player-list">
            <!-- Players will be populated dynamically -->
          </div>
        </div>

        <!-- Action Buttons -->
        <div id="actionButtons" class="action-buttons hidden">
          <button id="confirmBtn" class="button success" onclick="confirmAction()">Confirm</button>
          <button id="saveBtn" class="button" onclick="witchSave()" style="display: none;">Save Player</button>
          <button id="poisonBtn" class="button" onclick="witchPoison()" style="display: none;">Use Poison</button>
          <button id="skipBtn" class="button" onclick="skipAction()" style="display: none;">Skip</button>
          <button id="completeBtn" class="button" onclick="completeWitchAction()"
            style="display: none;">Complete</button>
        </div>

        <!-- Result Display -->
        <div id="resultDisplay" class="result-display hidden">
          <!-- Results will be shown here -->
        </div>
      </div>

      <!-- Host Controls (Day Phase) -->
      <div id="hostControls" class="hidden">
        <button id="checkNightBtn" class="button" onclick="checkLastNight()">Check Last Night Status</button>
      </div>

      <!-- Navigation -->
      <div style="margin-top: 30px;">
        <button class="button" onclick="showRolePage()">See My Role</button>
        <button class="button" onclick="showLobbyPage()">Back to Lobby</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null;
    let isHost = false;
    let currentRole = null;
    let pendingSeats = null; // Store seats data if received before seating area is created
    let sessionId = null; // Store session ID for reconnection

    // Role descriptions with language support
    const roleDescriptions = {
      en: {
        'werewolf': 'üê∫ You are a Werewolf! Work with other werewolves to eliminate villagers during the night.',
        'whitewolf': '‚ö™ You are the White Wolf! You are a werewolf, but you can also eliminate others by reveal yourself.',
        'villager': 'üë®‚Äçüåæ You are a Villager! Find and eliminate the werewolves during the day.',
        'seer': 'üîÆ You are the Seer! You can check one player\'s role each night.',
        'witch': 'üßô‚Äç‚ôÄÔ∏è You are the Witch! You have a healing potion and a poison potion.',
        'hunter': 'üèπ You are the Hunter! When you die, you can choose to eliminate another player.',
        'fool': 'üÉè You are the Fool! You win if the villagers win',
        'guard': 'üõ°Ô∏è You are the Guard! You can protect one player each night.',
        'cupid': 'üíò You are Cupid! On the first night, you choose two players to fall in love.',
        'orphan': 'üë∂ You are the Orphan! Choose your father at the beginning of the game.'
      },
      zh: {
        'werewolf': 'üê∫ ‰Ω†ÊòØÁãº‰∫∫ÔºÅÂú®Â§úÊôö‰∏éÂÖ∂‰ªñÁãº‰∫∫‰∏ÄËµ∑Ê∂àÁÅ≠ÊùëÊ∞ë„ÄÇ',
        'whitewolf': '‚ö™ ‰Ω†ÊòØÁôΩÁãºÁéãÔºÅ‰Ω†ÊòØÁãº‰∫∫Ôºå‰ΩÜ‰Ω†‰πüÂèØ‰ª•Ëá™ÁàÜÂ∏¶Ëµ∞‰∫∫„ÄÇ',
        'villager': 'üë®‚Äçüåæ ‰Ω†ÊòØÊùëÊ∞ëÔºÅÁôΩÂ§©ÊâæÂá∫Âπ∂Ê∂àÁÅ≠Áãº‰∫∫„ÄÇ',
        'seer': 'üîÆ ‰Ω†ÊòØÈ¢ÑË®ÄÂÆ∂ÔºÅÊØè‰∏™Â§úÊôö‰Ω†ÂèØ‰ª•Êü•È™å‰∏Ä‰∏™Áé©ÂÆ∂ÁöÑË∫´‰ªΩ„ÄÇ',
        'witch': 'üßô‚Äç‚ôÄÔ∏è ‰Ω†ÊòØÂ•≥Â∑´ÔºÅ‰Ω†Êúâ‰∏ÄÁì∂Ëß£ËçØÂíå‰∏ÄÁì∂ÊØíËçØ„ÄÇ',
        'hunter': 'üèπ ‰Ω†ÊòØÁåé‰∫∫ÔºÅÂΩì‰Ω†Ê≠ª‰∫°Êó∂Ôºå‰Ω†ÂèØ‰ª•ÈÄâÊã©Â∏¶Ëµ∞Âè¶‰∏Ä‰∏™Áé©ÂÆ∂„ÄÇ',
        'fool': 'üÉè ‰Ω†ÊòØÁôΩÁó¥ÔºÅÂ¶ÇÊûúÊùëÊ∞ëËé∑ËÉúÔºå‰Ω†Â∞±Ëé∑ËÉú„ÄÇ',
        'guard': 'üõ°Ô∏è ‰Ω†ÊòØÂÆàÂç´ÔºÅÊØè‰∏™Â§úÊôö‰Ω†ÂèØ‰ª•‰øùÊä§‰∏Ä‰∏™Áé©ÂÆ∂„ÄÇ',
        'cupid': 'üíò ‰Ω†ÊòØ‰∏òÊØîÁâπÔºÅÂú®Á¨¨‰∏Ä‰∏™Â§úÊôöÔºå‰Ω†ÈÄâÊã©‰∏§‰∏™Áé©ÂÆ∂Êàê‰∏∫ÊÅã‰∫∫„ÄÇ',
        'orphan': 'üë∂ ‰Ω†ÊòØÂ≠§ÂÑøÔºÅÂú®Ê∏∏ÊàèÂºÄÂßãÊó∂ÈÄâÊã©‰Ω†ÁöÑÁà∂‰∫≤„ÄÇ'
      }
    };

    // Function to get role description based on current language
    function getRoleDescription(role) {
      return roleDescriptions[gameLanguage]?.[role] || roleDescriptions['en'][role] || '';
    }

    // Page Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    function showLandingPage() {
      showPage('landing');
    }

    function showActionResult(message, type = 'success') {
      const resultDiv = document.getElementById('actionResult');
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';

      if (type === 'error') {
        resultDiv.style.backgroundColor = '#f8d7da';
        resultDiv.style.color = '#721c24';
      } else {
        resultDiv.style.backgroundColor = '#d4edda';
        resultDiv.style.color = '#155724';
      }
    }

    function showConfigPage() {
      showPage('configure');
      updateRoleInputs();
    }

    function showLobbyPage() {
      showPage('lobby');
    }

    function showRolePage() {
      showPage('role');
      socket.emit('getMyRole', currentRoom, (response) => {
        if (response.success) {
          currentRole = response.role;
          document.getElementById('roleDisplay').textContent = response.role.toUpperCase();
          document.getElementById('roleDescription').textContent = getRoleDescription(response.role);

          // Show role image
          const roleImage = document.getElementById('roleImage');
          const imagePath = getRoleImagePath(response.role);
          if (imagePath) {
            roleImage.src = imagePath;
            roleImage.alt = `${response.role} role image`;
            roleImage.style.display = 'block';
          } else {
            roleImage.style.display = 'none';
          }
        }
      });
    }

    // Function to get the correct image path for each role
    function getRoleImagePath(role) {
      const roleImageMap = {
        'werewolf': '/images/werewolf.jpg',
        'whitewolf': '/images/whitewolf.png',
        'villager': '/images/villager.jpg',
        'seer': '/images/sear.jpg', // Note: the file is named 'sear.jpg'
        'witch': '/images/witch.jpg',
        'hunter': '/images/hunter.jpg',
        'fool': '/images/fool.jpg',
        'guard': '/images/guard.jpg',
        'cupid': '/images/cubid.jpg', // Note: the file is named 'cubid.jpg'
        'orphan': '/images/orphan.png'
      };

      return roleImageMap[role] || null;
    }

    // Configuration
    function updateRoleInputs() {
      const totalPlayers = parseInt(document.getElementById('totalPlayers').value);
      const werewolvesInput = document.getElementById('numWerewolves');
      const villagersInput = document.getElementById('numVillagers');
      const orphansInput = document.getElementById('numOrphans');

      // Update max values - allow 4 werewolves for 11 players
      let maxWerewolves;
      if (totalPlayers >= 11) {
        maxWerewolves = 4;
      } else {
        maxWerewolves = Math.floor(totalPlayers / 3);
      }
      werewolvesInput.max = maxWerewolves;
      villagersInput.max = totalPlayers - 1;
      orphansInput.max = totalPlayers - 1;

      // Auto-update villagers count
      const werewolves = parseInt(werewolvesInput.value) || 0;
      const orphans = parseInt(orphansInput.value) || 0;
      const specialWolves = document.querySelectorAll('.special-wolves input:checked').length;
      const specialRoles = document.querySelectorAll('.special-roles input:checked').length;

      // Calculate: Total = Werewolves + Special Wolves + Villagers + Orphans + Special Roles
      villagersInput.value = Math.max(0, totalPlayers - werewolves - specialWolves - orphans - specialRoles);
    }

    function validateConfiguration() {
      const totalPlayers = parseInt(document.getElementById('totalPlayers').value);
      const werewolves = parseInt(document.getElementById('numWerewolves').value);
      const villagers = parseInt(document.getElementById('numVillagers').value);
      const orphans = parseInt(document.getElementById('numOrphans').value);
      const specialWolves = document.querySelectorAll('.special-wolves input:checked').length;
      const specialRoles = document.querySelectorAll('.special-roles input:checked').length;

      const validationElement = document.getElementById('roleValidation');

      // Rule 1: Werewolves + Special wolves must be >= 1
      if (werewolves + specialWolves < 1) {
        validationElement.textContent = `Error: Total werewolves (regular + special) must be at least 1`;
        validationElement.style.display = 'block';
        return false;
      }

      // Rule 2: Orphan + Villagers > 0
      if (orphans + villagers <= 0) {
        validationElement.textContent = 'Error: You must have at least 1 Orphan or Villager (Orphans + Villagers > 0)';
        validationElement.style.display = 'block';
        return false;
      }

      // Rule 3: Werewolves + Special Wolves + Orphans + Villagers + Special Roles = Total Players
      const totalRoles = werewolves + specialWolves + villagers + orphans + specialRoles;
      if (totalRoles !== totalPlayers) {
        validationElement.textContent = `Error: Total roles (${totalRoles}) must equal total players (${totalPlayers}). Werewolves(${werewolves}) + Special Wolves(${specialWolves}) + Villagers(${villagers}) + Orphans(${orphans}) + Special Roles(${specialRoles}) = ${totalRoles}`;
        validationElement.style.display = 'block';
        return false;
      }

      validationElement.style.display = 'none';
      return true;
    }

    function configureGame(event) {
      event.preventDefault();

      if (!validateConfiguration()) {
        return;
      }

      const config = {
        language: document.getElementById('gameLanguage').value,
        totalPlayers: parseInt(document.getElementById('totalPlayers').value),
        numWerewolves: parseInt(document.getElementById('numWerewolves').value),
        numVillagers: parseInt(document.getElementById('numVillagers').value),
        numOrphans: parseInt(document.getElementById('numOrphans').value),
        specialWolves: Array.from(document.querySelectorAll('.special-wolves input:checked')).map(cb => cb.value),
        specialRoles: Array.from(document.querySelectorAll('.special-roles input:checked')).map(cb => cb.value)
      };

      socket.emit('configureGame', config, (response) => {
        if (response.success) {
          // Ask for host name
          const hostName = prompt('Enter your name:');
          if (!hostName) return;

          socket.emit('createGame', (response) => {
            if (response.success) {
              currentRoom = response.roomId;
              isHost = true;

              // Join the room as host
              socket.emit('joinGame', { roomId: currentRoom, name: hostName }, (joinResponse) => {
                if (joinResponse.success) {
                  showLobbyPage();
                  document.getElementById('displayRoomCode').textContent = currentRoom;
                } else {
                  showMessage('landingMessage', joinResponse.message, 'error');
                }
              });
            } else {
              showMessage('landingMessage', response.message, 'error');
            }
          });
        } else {
          showMessage('landingMessage', response.message, 'error');
        }
      });
    }

    // Load session data from localStorage
    function loadSession() {
      try {
        const sessionData = localStorage.getItem('werewolfGameSession');
        if (sessionData) {
          const data = JSON.parse(sessionData);
          return data;
        }
      } catch (error) {
        console.log('Error loading session:', error);
        localStorage.removeItem('werewolfGameSession');
      }
      return null;
    }

    // Save session data to localStorage
    function saveSession(data) {
      try {
        localStorage.setItem('werewolfGameSession', JSON.stringify(data));
      } catch (error) {
        console.log('Error saving session:', error);
      }
    }

    // Clear session data
    function clearSession() {
      localStorage.removeItem('werewolfGameSession');
    }

    // Check for existing session on page load
    function checkForExistingSession() {
      const session = loadSession();
      if (session && session.roomId && session.playerName && session.sessionId) {
        // Pre-fill the form with saved data
        document.getElementById('playerName').value = session.playerName;
        document.getElementById('roomCode').value = session.roomId;

        // Show reconnection option
        const landingMessage = document.getElementById('landingMessage');
        landingMessage.innerHTML = `
          <div class="success">
            Found previous game session: Room ${session.roomId} as ${session.playerName}
            <br>
            <button class="button success" onclick="reconnectToGame()" style="margin: 10px;">üîÑ Reconnect to Game</button>
            <button class="button" onclick="clearSession(); location.reload();" style="margin: 10px;">‚ùå Start Fresh</button>
          </div>
        `;
      }
    }

    // Reconnect to previous game
    function reconnectToGame() {
      const session = loadSession();
      if (!session) {
        showMessage('landingMessage', 'No saved session found', 'error');
        return;
      }

      socket.emit('joinGame', {
        roomId: session.roomId,
        name: session.playerName,
        sessionId: session.sessionId
      }, (response) => {
        if (response.success) {
          currentRoom = session.roomId;
          isHost = response.isHost;
          sessionId = response.sessionId;

          // Update session with new socket connection
          saveSession({
            roomId: currentRoom,
            playerName: session.playerName,
            sessionId: sessionId
          });

          showLobbyPage();
          document.getElementById('displayRoomCode').textContent = currentRoom;

          const message = response.isReconnecting ?
            'Successfully reconnected to your game! Welcome back! üéâ' :
            response.message;
          showMessage('lobbyMessage', message, 'success');
        } else {
          // Reconnection failed, clear invalid session
          clearSession();
          showMessage('landingMessage', response.message, 'error');
        }
      });
    }

    // Join Game (updated to handle session persistence)
    function joinGame() {
      const name = document.getElementById('playerName').value.trim();
      const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();

      if (!name) {
        showMessage('landingMessage', getText('pleaseEnterName'), 'error');
        return;
      }

      if (!roomCode) {
        showMessage('landingMessage', getText('pleaseEnterRoomCode'), 'error');
        return;
      }

      // Check if we have a previous session for this room and player
      const existingSession = loadSession();
      const existingSessionId = (existingSession &&
        existingSession.roomId === roomCode &&
        existingSession.playerName === name) ?
        existingSession.sessionId : null;

      socket.emit('joinGame', {
        roomId: roomCode,
        name: name,
        sessionId: existingSessionId
      }, (response) => {
        if (response.success) {
          currentRoom = roomCode;
          isHost = response.isHost;
          sessionId = response.sessionId;

          // Save session data for persistence
          saveSession({
            roomId: roomCode,
            playerName: name,
            sessionId: sessionId
          });

          showLobbyPage();
          document.getElementById('displayRoomCode').textContent = roomCode;

          const message = response.isReconnecting ?
            'Successfully reconnected to your game! Welcome back! üéâ' :
            response.message;
          showMessage('lobbyMessage', message, 'success');
        } else {
          showMessage('landingMessage', response.message, 'error');
        }
      });
    }

    // Seating
    // Game phase state
    let gameStarted = false;

    function createSeatingArea(totalPlayers) {
      const seatingArea = document.getElementById('seatingArea');
      seatingArea.innerHTML = '';

      for (let i = 1; i <= totalPlayers; i++) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.setAttribute('data-seat', i);
        seat.innerHTML = `
          <div class="seat-number">${getText('seat')} ${i}</div>
          <div class="seat-player" id="seat-${i}-player"></div>
        `;

        seat.onclick = () => handleSeatClick(i);
        seatingArea.appendChild(seat);
      }
    }

    function handleSeatClick(seatId) {
      if (gameStarted && currentPhase) {
        // During game phase - handle player targeting
        const seat = document.querySelector(`[data-seat="${seatId}"]`);
        if (seat && seat.classList.contains('selectable')) {
          selectSeatForAction(seatId);
        }
      } else {
        // During lobby phase - handle seat selection
        chooseSeat(seatId);
      }
    }

    function chooseSeat(seatId) {
      socket.emit('chooseSeat', { roomId: currentRoom, seatId }, (response) => {
        if (response.success) {
          showMessage('lobbyMessage', response.message, 'success');
        } else {
          showMessage('lobbyMessage', response.message, 'error');
        }
      });
    }

    function updateSeats(seats) {
      seats.forEach(seat => {
        const seatElement = document.querySelector(`[data-seat="${seat.id}"]`);
        const playerElement = document.getElementById(`seat-${seat.id}-player`);

        if (seat.player) {
          seatElement.classList.add('occupied');

          // Check if player is disconnected
          if (seat.player.isConnected === false) {
            seatElement.classList.add('disconnected');
            seatElement.classList.remove('occupied');
          } else {
            seatElement.classList.remove('disconnected');
          }

          playerElement.textContent = seat.player.name;
          seatElement.onclick = null; // Remove click handler
        } else {
          seatElement.classList.remove('occupied', 'disconnected');
          playerElement.textContent = '';
          seatElement.onclick = () => chooseSeat(seat.id);
        }
      });
    }

    // Game Controls
    function startGame() {
      socket.emit('startGame', currentRoom, (response) => {
        if (response.success) {
          showMessage('lobbyMessage', response.message, 'success');
        } else {
          showMessage('lobbyMessage', response.message, 'error');
        }
      });
    }

    function shuffleRoles() {
      if (confirm('Are you sure you want to shuffle roles? This will reset the game and assign new roles to all players.')) {
        socket.emit('shuffleRoles', { roomId: currentRoom }, (response) => {
          if (response.success) {
            showMessage('lobbyMessage', response.message, 'success');
          } else {
            showMessage('lobbyMessage', response.message, 'error');
          }
        });
      }
    }

    // Utility Functions
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => {
        element.innerHTML = '';
      }, 5000);
    }

    // Socket Event Listeners
    socket.on('gameConfig', (config) => {
      document.getElementById('displayTotalPlayers').textContent = config.totalPlayers;
      document.getElementById('totalPlayerCount').textContent = config.totalPlayers;
      document.getElementById('displayWerewolves').textContent = config.numWerewolves || 0;
      document.getElementById('displayVillagers').textContent = config.numVillagers || 0;
      document.getElementById('displayOrphans').textContent = config.numOrphans || 0;
      createSeatingArea(config.totalPlayers);

      // Store the game language for audio and UI
      gameLanguage = config.language || 'en';

      // Update all UI text based on selected language
      updateUILanguage();

      // If we received seats data before the seating area was created, apply it now
      if (pendingSeats) {
        updateSeats(pendingSeats);
        pendingSeats = null;
      }
    });

    socket.on('updateSeats', (seats) => {
      // Check if seating area exists, if not, store the seats data
      const seatingArea = document.getElementById('seatingArea');
      if (seatingArea && seatingArea.children.length > 0) {
        updateSeats(seats);
      } else {
        pendingSeats = seats;
      }
    });

    // Updated to handle roles being assigned before game starts
    socket.on('seatsStatus', (status) => {
      document.getElementById('seatedCount').textContent = status.filled;

      if (isHost) {
        // TESTING: Enable start game button when at least 1 player is seated AND roles assigned
        document.getElementById('startGameBtn').disabled = !(status.filled >= 1 && status.rolesAssigned);

        // Show shuffle roles button only to host and when roles are assigned
        const shuffleBtn = document.getElementById('shuffleRolesBtn');
        if (status.rolesAssigned) {
          shuffleBtn.style.display = 'inline-block';
        } else {
          shuffleBtn.style.display = 'none';
        }
      }
    });

    // Show role button as soon as role is assigned (before game starts)
    socket.on('roleAssigned', (role) => {
      currentRole = role;
      document.getElementById('seeRoleBtn').style.display = 'inline-block';
      showMessage('lobbyMessage', getText('roleAssigned'), 'success');
    });

    // Notify all players when roles are assigned
    socket.on('rolesAssigned', (data) => {
      document.getElementById('roleStatusText').textContent = getText('assigned');
      document.getElementById('roleStatusText').className = 'role-status assigned';
      showMessage('lobbyMessage', getText('allRolesAssigned'), 'success');
    });

    // Handle roles shuffled event
    socket.on('rolesShuffled', (data) => {
      showMessage('lobbyMessage', data.message, 'success');
      // Hide shuffle button briefly to prevent spam clicking
      const shuffleBtn = document.getElementById('shuffleRolesBtn');
      if (shuffleBtn) {
        shuffleBtn.disabled = true;
        setTimeout(() => {
          shuffleBtn.disabled = false;
        }, 2000);
      }
    });

    socket.on('gameStarted', (data) => {
      gameStarted = true; // Set game started flag
      showMessage('lobbyMessage', `Game officially started! Phase: ${data.phase}`, 'success');
      // You can add additional game phase UI updates here
    });

    socket.on('hostDisconnected', () => {
      showMessage('lobbyMessage', 'Host disconnected. Game ended.', 'error');
      setTimeout(() => {
        showLandingPage();
      }, 3000);
    });

    // Game Phase Variables
    let selectedPlayerId = null;
    let selectedPlayerIds = []; // For cupid selecting multiple players
    let currentPhase = null;
    let witchActions = { saved: false, poisoned: false };
    let gameLanguage = 'en'; // Default to English
    let currentPlayers = []; // Store current players data for game phases
    let isLover = false; // Track if current player is a lover
    let partnerName = null; // Store lover partner's name

    // Language translations for UI
    const uiTexts = {
      en: {
        // Main titles
        werewolvesGame: "üê∫ Werewolves Game",
        gameConfiguration: "‚öôÔ∏è Game Configuration",
        gameLobby: "üè† Game Lobby",
        yourRole: "üé≠ Your Role",
        gameInProgress: "üéÆ Game in Progress",

        // Landing page
        joinGame: "Join Game",
        hostGame: "Host Game",
        enterYourName: "Enter your name",
        enterRoomCode: "Enter room code",
        configureCreateGame: "Configure & Create Game",

        // Configuration page
        gameLanguage: "Game Language:",
        totalPlayers: "Total Players:",
        numberOfWerewolves: "Number of Werewolves:",
        specialWolves: "Special Wolves:",
        numberOfVillagers: "Number of Villagers:",
        numberOfOrphans: "Number of Orphans:",
        specialRoles: "Special Roles:",
        createRoom: "Create Room",
        back: "Back",

        // Special role names
        seer: "üîÆ Seer",
        witch: "üßô‚Äç‚ôÄÔ∏è Witch",
        hunter: "üèπ Hunter",
        fool: "üÉè Fool",
        guard: "üõ°Ô∏è Guard",
        cupid: "üíò Cupid",

        // Lobby page
        roomCode: "Room Code:",
        seatedPlayers: "Seated Players:",
        roles: "Roles:",
        chooseYourSeat: "Choose Your Seat",
        startGame: "Start Game",
        seeYourRole: "See Your Role",
        leaveGame: "Leave Game",
        notAssigned: "Not assigned",
        assigned: "Assigned ‚úÖ",

        // Seat labels
        seat: "Seat",

        // Game page
        nightTimeInstructions: "üåô Night Time - Listen for Instructions",
        werewolvesTurn: "üê∫ Werewolves Turn",
        witchTurn: "üßô‚Äç‚ôÄÔ∏è Witch Turn",
        seerTurn: "üîÆ Seer Turn",
        hunterTurn: "üèπ Hunter Turn",
        closeYourEyes: "üëÅÔ∏è Close Your Eyes",

        // Action titles
        choosePlayerToKill: "Choose a player to kill:",
        choosePlayerToCheck: "Choose a player to check:",
        witchActions: "Witch actions:",
        wasKilledSaveThem: "was killed. Save them?",
        poisonNotification: "POISON NOTIFICATION",

        // Buttons
        confirm: "Confirm",
        savePlayer: "Save Player",
        usePoison: "Use Poison",
        skip: "Skip",
        complete: "Complete",
        checkLastNightStatus: "Check Last Night Status",
        seeMyRole: "See My Role",
        backToLobby: "Back to Lobby",
        backToGame: "Back to Game",

        // Messages
        gameStarting: "Game Starting...",
        playerSaved: "Player saved!",
        playerPoisoned: "Player poisoned!",
        pleaseSelectPlayer: "Please select a player to poison",
        cannotSaveYourself: "You cannot save yourself!",
        poisonedGunDisabled: "You have been poisoned! Your gun is disabled and you cannot use it during the day.",

        // Validation messages
        pleaseEnterName: "Please enter your name",
        pleaseEnterRoomCode: "Please enter room code",
        totalRolesMustEqual: "Total roles ({0}) must equal total players ({1})",

        // Status messages
        joinedSuccessfully: "Joined successfully!",
        roleAssigned: "Your role has been assigned! Click \"See Your Role\" to view it.",
        allRolesAssigned: "All players are seated and roles assigned!",
        hostDisconnected: "Host disconnected. Game ended.",
      },
      zh: {
        // Main titles
        werewolvesGame: "üê∫ Áãº‰∫∫ÊùÄÊ∏∏Êàè",
        gameConfiguration: "‚öôÔ∏è Ê∏∏ÊàèÈÖçÁΩÆ",
        gameLobby: "üè† Ê∏∏ÊàèÂ§ßÂéÖ",
        yourRole: "üé≠ ‰Ω†ÁöÑË∫´‰ªΩ",
        gameInProgress: "üéÆ Ê∏∏ÊàèËøõË°å‰∏≠",

        // Landing page
        joinGame: "Âä†ÂÖ•Ê∏∏Êàè",
        hostGame: "ÂàõÂª∫Ê∏∏Êàè",
        enterYourName: "ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂßìÂêç",
        enterRoomCode: "ËØ∑ËæìÂÖ•ÊàøÈó¥‰ª£Á†Å",
        configureCreateGame: "ÈÖçÁΩÆÂπ∂ÂàõÂª∫Ê∏∏Êàè",

        // Configuration page
        gameLanguage: "Ê∏∏ÊàèËØ≠Ë®Ä:",
        totalPlayers: "ÊÄªÁé©ÂÆ∂Êï∞:",
        numberOfWerewolves: "Áãº‰∫∫Êï∞Èáè:",
        specialWolves: "ÁâπÊÆäÁãº‰∫∫:",
        numberOfVillagers: "ÊùëÊ∞ëÊï∞Èáè:",
        numberOfOrphans: "Â≠§ÂÑøÊï∞Èáè:",
        specialRoles: "ÁâπÊÆäË∫´‰ªΩ:",
        createRoom: "ÂàõÂª∫ÊàøÈó¥",
        back: "ËøîÂõû",

        // Special role names
        seer: "üîÆ È¢ÑË®ÄÂÆ∂",
        witch: "üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´",
        hunter: "üèπ Áåé‰∫∫",
        fool: "üÉè ÁôΩÁó¥",
        guard: "üõ°Ô∏è ÂÆàÂç´",
        cupid: "üíò ‰∏òÊØîÁâπ",

        // Lobby page
        roomCode: "ÊàøÈó¥‰ª£Á†Å:",
        seatedPlayers: "Â∑≤Â∞±Â∫ßÁé©ÂÆ∂:",
        roles: "Ë∫´‰ªΩ:",
        chooseYourSeat: "ÈÄâÊã©‰Ω†ÁöÑÂ∫ß‰Ωç",
        startGame: "ÂºÄÂßãÊ∏∏Êàè",
        seeYourRole: "Êü•Áúã‰Ω†ÁöÑË∫´‰ªΩ",
        leaveGame: "Á¶ªÂºÄÊ∏∏Êàè",
        notAssigned: "Êú™ÂàÜÈÖç",
        assigned: "Â∑≤ÂàÜÈÖç ‚úÖ",

        // Seat labels
        seat: "Â∫ß‰Ωç",

        // Game page
        nightTimeInstructions: "üåô Â§úÊôöÊó∂Èó¥ - ËØ∑Âê¨‰ªéÊåáÁ§∫",
        werewolvesTurn: "üê∫ Áãº‰∫∫ÂõûÂêà",
        witchTurn: "üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ÂõûÂêà",
        seerTurn: "üîÆ È¢ÑË®ÄÂÆ∂ÂõûÂêà",
        hunterTurn: "üèπ Áåé‰∫∫ÂõûÂêà",
        closeYourEyes: "üëÅÔ∏è ËØ∑Èó≠‰∏ä‰Ω†ÁöÑÁúºÁùõ",

        // Action titles
        choosePlayerToKill: "ÈÄâÊã©‰∏Ä‰∏™Áé©ÂÆ∂ÊùÄÊ≠ª:",
        choosePlayerToCheck: "ÈÄâÊã©‰∏Ä‰∏™Áé©ÂÆ∂Êü•È™å:",
        witchActions: "Â•≥Â∑´Ë°åÂä®:",
        wasKilledSaveThem: "Ë¢´ÊùÄÊ≠ª‰∫Ü„ÄÇË¶ÅÊïë‰ªñ‰ª¨Âêó?",
        poisonNotification: "‰∏≠ÊØíÈÄöÁü•",

        // Buttons
        confirm: "Á°ÆËÆ§",
        savePlayer: "ÊïëÊ≤ªÁé©ÂÆ∂",
        usePoison: "‰ΩøÁî®ÊØíËçØ",
        skip: "Ë∑≥Ëøá",
        complete: "ÂÆåÊàê",
        checkLastNightStatus: "Êü•ÁúãÊò®Â§úÁä∂ÊÄÅ",
        seeMyRole: "Êü•ÁúãÊàëÁöÑË∫´‰ªΩ",
        backToLobby: "ËøîÂõûÂ§ßÂéÖ",
        backToGame: "ËøîÂõûÊ∏∏Êàè",

        // Messages
        gameStarting: "Ê∏∏ÊàèÂºÄÂßã‰∏≠...",
        playerSaved: "Áé©ÂÆ∂Â∑≤Ë¢´ÊïëÊ≤ª!",
        playerPoisoned: "Áé©ÂÆ∂Â∑≤Ë¢´‰∏ãÊØí!",
        pleaseSelectPlayer: "ËØ∑ÈÄâÊã©‰∏Ä‰∏™Áé©ÂÆ∂‰∏ãÊØí",
        cannotSaveYourself: "‰Ω†‰∏çËÉΩÊïëËá™Â∑±!",
        poisonedGunDisabled: "‰Ω†Â∑≤Ë¢´‰∏ãÊØíÔºÅ‰Ω†ÁöÑÊû™Ë¢´Á¶ÅÁî®ÔºåÁôΩÂ§©Êó†Ê≥ï‰ΩøÁî®„ÄÇ",

        // Validation messages
        pleaseEnterName: "ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂßìÂêç",
        pleaseEnterRoomCode: "ËØ∑ËæìÂÖ•ÊàøÈó¥‰ª£Á†Å",
        totalRolesMustEqual: "ÊÄªË∫´‰ªΩÊï∞ ({0}) ÂøÖÈ°ªÁ≠â‰∫éÊÄªÁé©ÂÆ∂Êï∞ ({1})",

        // Status messages
        joinedSuccessfully: "ÊàêÂäüÂä†ÂÖ•!",
        roleAssigned: "‰Ω†ÁöÑË∫´‰ªΩÂ∑≤ÂàÜÈÖçÔºÅÁÇπÂáª\"Êü•Áúã‰Ω†ÁöÑË∫´‰ªΩ\"Êù•Êü•Áúã„ÄÇ",
        allRolesAssigned: "ÊâÄÊúâÁé©ÂÆ∂Â∑≤Â∞±Â∫ßÂπ∂ÂàÜÈÖçË∫´‰ªΩÔºÅ",
        hostDisconnected: "Êàø‰∏ªÂ∑≤Êñ≠ÂºÄËøûÊé•„ÄÇÊ∏∏ÊàèÁªìÊùü„ÄÇ",
      }
    };

    // Function to get localized text
    function getText(key, ...args) {
      let text = uiTexts[gameLanguage]?.[key] || uiTexts['en'][key] || key;
      // Replace placeholders {0}, {1}, etc. with arguments
      args.forEach((arg, index) => {
        text = text.replace(`{${index}}`, arg);
      });
      return text;
    }

    // Function to update all UI text based on current language
    function updateUILanguage() {
      // Helper function to safely update element text
      function safeUpdateText(selector, textKey) {
        const element = document.querySelector(selector);
        if (element) {
          element.textContent = getText(textKey);
        }
      }

      function safeUpdatePlaceholder(selector, textKey) {
        const element = document.querySelector(selector);
        if (element) {
          element.placeholder = getText(textKey);
        }
      }

      // Main page titles
      safeUpdateText('#landing h1', 'werewolvesGame');
      safeUpdateText('#configure h2', 'gameConfiguration');
      safeUpdateText('#lobby h2', 'gameLobby');
      safeUpdateText('#role h2', 'yourRole');
      safeUpdateText('#game h2', 'gameInProgress');

      // Landing page
      safeUpdateText('#landing h3:first-of-type', 'joinGame');
      safeUpdateText('#landing h3:last-of-type', 'hostGame');
      safeUpdatePlaceholder('#playerName', 'enterYourName');
      safeUpdatePlaceholder('#roomCode', 'enterRoomCode');
      safeUpdateText('#landing button:first-of-type', 'joinGame');
      safeUpdateText('#landing button.success', 'configureCreateGame');

      // Configuration page labels
      safeUpdateText('label[for="gameLanguage"]', 'gameLanguage');
      safeUpdateText('label[for="totalPlayers"]', 'totalPlayers');
      safeUpdateText('label[for="numWerewolves"]', 'numberOfWerewolves');
      safeUpdateText('label[for="numVillagers"]', 'numberOfVillagers');
      safeUpdateText('label[for="numOrphans"]', 'numberOfOrphans');

      // Special Wolves and Special Roles labels (not direct input labels, handled separately)
      const labels = document.querySelectorAll('.config-form label');
      labels.forEach(label => {
        if (label.textContent.includes('Special Wolves') || label.textContent.includes('ÁâπÊÆäÁãº‰∫∫')) {
          label.textContent = getText('specialWolves');
        }
        if (label.textContent.includes('Special Roles') || label.textContent.includes('ÁâπÊÆäË∫´‰ªΩ')) {
          label.textContent = getText('specialRoles');
        }
      });

      // Update special role checkboxes
      updateSpecialRoleLabels();

      // Configuration page buttons
      safeUpdateText('.config-form button[type="submit"]', 'createRoom');
      safeUpdateText('.config-form button[type="button"]', 'back');

      // Lobby page
      const gameInfoLabels = document.querySelectorAll('#gameInfo div strong');
      if (gameInfoLabels.length >= 4) {
        gameInfoLabels[0].textContent = getText('roomCode');
        gameInfoLabels[1].textContent = getText('totalPlayers');
        gameInfoLabels[2].textContent = getText('seatedPlayers');
        gameInfoLabels[3].textContent = getText('roles');
      }

      safeUpdateText('#lobby h3', 'chooseYourSeat');

      // Lobby buttons
      const startGameBtn = document.getElementById('startGameBtn');
      if (startGameBtn) startGameBtn.textContent = getText('startGame');

      const seeRoleBtn = document.getElementById('seeRoleBtn');
      if (seeRoleBtn) seeRoleBtn.textContent = getText('seeYourRole');

      safeUpdateText('#lobby button:last-of-type', 'leaveGame');

      // Update role status text
      const roleStatusElement = document.getElementById('roleStatusText');
      if (roleStatusElement) {
        if (roleStatusElement.classList.contains('assigned')) {
          roleStatusElement.textContent = getText('assigned');
        } else {
          roleStatusElement.textContent = getText('notAssigned');
        }
      }

      // Role descriptions
      updateRoleDescriptions();

      // Game page buttons
      const confirmBtn = document.getElementById('confirmBtn');
      if (confirmBtn) confirmBtn.textContent = getText('confirm');

      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn) saveBtn.textContent = getText('savePlayer');

      const poisonBtn = document.getElementById('poisonBtn');
      if (poisonBtn) poisonBtn.textContent = getText('usePoison');

      const skipBtn = document.getElementById('skipBtn');
      if (skipBtn) skipBtn.textContent = getText('skip');

      const completeBtn = document.getElementById('completeBtn');
      if (completeBtn) completeBtn.textContent = getText('complete');

      const checkNightBtn = document.getElementById('checkNightBtn');
      if (checkNightBtn) checkNightBtn.textContent = getText('checkLastNightStatus');

      safeUpdateText('#game button:nth-last-child(2)', 'seeMyRole');
      safeUpdateText('#game button:last-child', 'backToLobby');
      safeUpdateText('#role button', 'backToGame');

      // Update seat labels if they exist
      updateSeatLabels();
    }

    function updateSpecialRoleLabels() {
      const specialRoleCheckboxes = document.querySelectorAll('.special-roles label');
      const roleKeys = ['seer', 'witch', 'hunter', 'fool', 'guard', 'cupid'];

      specialRoleCheckboxes.forEach((label, index) => {
        if (index < roleKeys.length) {
          const checkbox = label.querySelector('input');
          const roleText = getText(roleKeys[index]);
          label.innerHTML = `${checkbox.outerHTML} ${roleText}`;
        }
      });
    }

    function updateRoleDescriptions() {
      const roleDescriptionsLang = {
        en: {
          'werewolf': 'üê∫ You are a Werewolf! Work with other werewolves to eliminate villagers during the night.',
          'villager': 'üë®‚Äçüåæ You are a Villager! Find and eliminate the werewolves during the day.',
          'seer': 'üîÆ You are the Seer! You can check one player\'s role each night.',
          'witch': 'üßô‚Äç‚ôÄÔ∏è You are the Witch! You have a healing potion and a poison potion.',
          'hunter': 'üèπ You are the Hunter! When you die, you can choose to eliminate another player.',
          'fool': 'üÉè You are the Fool! You win if the villagers mistakenly vote you out.',
          'guard': 'üõ°Ô∏è You are the Guard! You can protect one player each night.',
          'cupid': 'üíò You are Cupid! On the first night, you choose two players to fall in love.'
        },
        zh: {
          'werewolf': 'üê∫ ‰Ω†ÊòØÁãº‰∫∫ÔºÅ‰∏éÂÖ∂‰ªñÁãº‰∫∫Âêà‰ΩúÔºåÂú®Â§úÊôöÊ∂àÁÅ≠ÊùëÊ∞ë„ÄÇ',
          'villager': 'üë®‚Äçüåæ ‰Ω†ÊòØÊùëÊ∞ëÔºÅÂú®ÁôΩÂ§©ÊâæÂá∫Âπ∂Ê∂àÁÅ≠Áãº‰∫∫„ÄÇ',
          'seer': 'üîÆ ‰Ω†ÊòØÈ¢ÑË®ÄÂÆ∂ÔºÅÊØèÊôöÂèØ‰ª•Êü•È™å‰∏Ä‰∏™Áé©ÂÆ∂ÁöÑË∫´‰ªΩ„ÄÇ',
          'witch': 'üßô‚Äç‚ôÄÔ∏è ‰Ω†ÊòØÂ•≥Â∑´ÔºÅ‰Ω†Êúâ‰∏ÄÁì∂Ëß£ËçØÂíå‰∏ÄÁì∂ÊØíËçØ„ÄÇ',
          'hunter': 'üèπ ‰Ω†ÊòØÁåé‰∫∫ÔºÅÂΩì‰Ω†Ê≠ª‰∫°Êó∂ÔºåÂèØ‰ª•ÈÄâÊã©Ê∂àÁÅ≠Âè¶‰∏Ä‰∏™Áé©ÂÆ∂„ÄÇ',
          'fool': 'üÉè ‰Ω†ÊòØÁôΩÁó¥ÔºÅÂ¶ÇÊûúÊùëÊ∞ëÈîôËØØÂú∞ÊäïÁ•®Ê∑òÊ±∞‰Ω†Ôºå‰Ω†Â∞±Ëé∑ËÉú„ÄÇ',
          'guard': 'üõ°Ô∏è ‰Ω†ÊòØÂÆàÂç´ÔºÅÊØèÊôöÂèØ‰ª•‰øùÊä§‰∏Ä‰∏™Áé©ÂÆ∂„ÄÇ',
          'cupid': 'üíò ‰Ω†ÊòØ‰∏òÊØîÁâπÔºÅÁ¨¨‰∏ÄÊôöÈÄâÊã©‰∏§‰∏™Áé©ÂÆ∂Áõ∏Áà±„ÄÇ'
        }
      };

      // Update global roleDescriptions object
      Object.assign(roleDescriptions, roleDescriptionsLang[gameLanguage] || roleDescriptionsLang['en']);
    }

    function updateSeatLabels() {
      const seats = document.querySelectorAll('.seat-number');
      seats.forEach((seatElement, index) => {
        const seatNumber = index + 1;
        seatElement.textContent = `${getText('seat')} ${seatNumber}`;
      });
    }

    // Audio/Speech functionality
    let speechSynthesis = window.speechSynthesis;
    let isSpeaking = false;

    function speakText(text, callback) {
      console.log('Attempting to speak:', text);

      if (!speechSynthesis) {
        console.log('Speech synthesis not supported');
        if (callback) callback();
        return;
      }

      // Cancel any ongoing speech
      speechSynthesis.cancel();

      // Wait a bit for cancel to complete
      setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.8; // Slightly slower for clarity
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Set language based on game configuration
        utterance.lang = gameLanguage === 'zh' ? 'zh-CN' : 'en-US';

        utterance.onstart = () => {
          console.log('Speech started:', text);
          isSpeaking = true;
        };

        utterance.onend = () => {
          console.log('Speech ended:', text);
          isSpeaking = false;
          if (callback) {
            setTimeout(callback, 500); // Small delay after speech
          }
        };

        utterance.onerror = (event) => {
          // Don't log "canceled" errors as they're expected when interrupting speech
          if (event.error !== 'canceled') {
            console.error('Speech error:', event);
          } else {
            console.log('Speech was canceled (expected)');
          }
          isSpeaking = false;
          if (callback) callback();
        };

        try {
          speechSynthesis.speak(utterance);
          console.log('Speech utterance queued');
        } catch (error) {
          console.error('Error speaking:', error);
          if (callback) callback();
        }
      }, 100);
    }

    function stopSpeech() {
      if (speechSynthesis) {
        speechSynthesis.cancel();
        isSpeaking = false;
      }
    }

    // Audio test function
    function testAudio() {
      const testMessage = gameLanguage === 'zh' ? 'ÊµãËØïÈü≥È¢ëÂäüËÉΩÊ≠£Â∏∏Â∑•‰Ωú' : 'Audio test is working';
      console.log('Testing audio with message:', testMessage);

      // Ensure user interaction enables audio
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }

      // Wait a moment then try to speak
      setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(testMessage);
        utterance.lang = gameLanguage === 'zh' ? 'zh-CN' : 'en-US';
        utterance.rate = 0.8;
        utterance.volume = 1.0;

        utterance.onstart = () => {
          console.log('‚úÖ Audio started successfully!');
          showMessage('lobbyMessage', 'Audio is working! üîä', 'success');
        };

        utterance.onerror = (event) => {
          console.error('‚ùå Audio error:', event);
          showMessage('lobbyMessage', `Audio error: ${event.error}`, 'error');
        };

        utterance.onend = () => {
          console.log('Audio test completed');
        };

        console.log('Starting direct speech synthesis...');
        speechSynthesis.speak(utterance);
      }, 100);
    }

    // Game Phase Functions
    function showGamePage() {
      showPage('game');
    }

    function createPlayerList(players) {
      const playerList = document.getElementById('playerList');
      playerList.innerHTML = '';

      players.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.setAttribute('data-player', player.id);
        playerCard.innerHTML = `
          <div><strong>Seat ${player.seat}</strong></div>
          <div>${player.name}</div>
        `;

        playerCard.onclick = () => selectPlayer(player.id, playerCard);
        playerList.appendChild(playerCard);
      });
    }

    function selectPlayer(playerId, cardElement) {
      // Clear previous selection
      document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('selected');
      });

      // Select new player
      cardElement.classList.add('selected');
      selectedPlayerId = playerId;

      // Show confirm button
      document.getElementById('confirmBtn').style.display = 'inline-block';
    }

    function confirmAction() {
      if (!selectedPlayerId) return;

      if (currentPhase === 'werewolf') {
        socket.emit('werewolfKill', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            hideActionArea();
          }
        });
      } else if (currentPhase === 'seer') {
        socket.emit('seerCheck', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            document.getElementById('confirmBtn').style.display = 'none';
          }
        });
      }

      selectedPlayerId = null;
    }

    // Lobby-based witch functions
    function witchSave() {
      socket.emit('witchSave', { roomId: currentRoom }, (response) => {
        if (response.success) {
          witchActions.saved = true;
          document.getElementById('witchSaveBtn').style.display = 'none';
          showActionResult(getText('playerSaved'));
        } else {
          showActionResult(response.message, 'error');
        }
      });
    }

    function witchPoison() {
      // Use the stored player data from when witch phase UI was received
      if (currentPlayers && currentPlayers.length > 0) {
        // Make all occupied seats selectable for witch to poison
        currentPlayers.forEach(player => {
          const seat = document.querySelector(`[data-seat="${player.seat}"]`);
          if (seat && seat.classList.contains('occupied')) {
            seat.classList.add('selectable');
            seat.setAttribute('data-player-id', player.id);
            seat.onclick = () => selectSeatForAction(player.seat, player.id);
          }
        });
      }
    }

    function skipWitchAction() {
      completeWitchAction();
    }

    function completeWitchAction() {
      socket.emit('witchComplete', { roomId: currentRoom }, (response) => {
        if (response.success) {
          hideGameActionUI();
        }
      });
    }

    function skipAction() {
      if (currentPhase === 'witch') {
        skipWitchAction();
      }
    }

    function checkLastNight() {
      socket.emit('checkLastNight', { roomId: currentRoom }, (response) => {
        if (response.success) {
          alert(response.message);
        }
      });
    }

    function hideActionArea() {
      document.getElementById('actionArea').classList.add('hidden');
      document.getElementById('playerSelection').classList.add('hidden');
      document.getElementById('actionButtons').classList.add('hidden');
      document.getElementById('resultDisplay').classList.add('hidden');

      // Reset buttons
      document.getElementById('confirmBtn').style.display = 'none';
      document.getElementById('saveBtn').style.display = 'none';
      document.getElementById('poisonBtn').style.display = 'none';
      document.getElementById('skipBtn').style.display = 'none';
      document.getElementById('completeBtn').style.display = 'none';

      selectedPlayerId = null;
    }

    // Game Phase Functions for Lobby-based UI
    function resetSeatStates() {
      document.querySelectorAll('.seat').forEach(seat => {
        seat.classList.remove('selectable', 'selected', 'dead');
      });
    }

    function makeSeatSelectable(seatId) {
      const seat = document.querySelector(`[data-seat="${seatId}"]`);
      if (seat && seat.classList.contains('occupied')) {
        seat.classList.add('selectable');
      }
    }

    function selectSeat(seatId) {
      // Clear previous selections
      document.querySelectorAll('.seat').forEach(seat => {
        seat.classList.remove('selected');
      });

      // Select the clicked seat
      const seat = document.querySelector(`[data-seat="${seatId}"]`);
      if (seat) {
        seat.classList.add('selected');
        selectedPlayerId = getSeatPlayerId(seatId);
        document.getElementById('confirmSelection').style.display = 'inline-block';
      }
    }

    function getSeatPlayerId(seatId) {
      // Get player ID from seat ID - you'll need to track this mapping
      // For now, we'll use the seat ID as player ID (this should be improved)
      const seatElement = document.querySelector(`[data-seat="${seatId}"]`);
      return seatElement ? seatElement.getAttribute('data-player-id') : null;
    }

    function confirmSelection() {
      if (!selectedPlayerId) {
        alert(getText('pleaseSelectPlayer'));
        return;
      }

      if (currentPhase === 'werewolf') {
        socket.emit('werewolfKill', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            hideGameActionUI();
            showActionResult(getText('playerSelected'));
          }
        });
      } else if (currentPhase === 'seer') {
        socket.emit('seerCheck', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            document.getElementById('confirmSelection').style.display = 'none';
            // Don't show "Checking player..." - wait for actual result
          }
        });
      } else if (currentPhase === 'witch') {
        socket.emit('witchPoison', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            witchActions.poisoned = true;
            document.getElementById('witchPoisonBtn').style.display = 'none';
            showActionResult(getText('playerPoisoned'));

            // Clear seat selection after poison
            resetSeatStates();
            selectedPlayerId = null;
            document.getElementById('confirmSelection').style.display = 'none';
          }
        });
      } else if (currentPhase === 'guard') {
        socket.emit('guardProtect', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            hideGameActionUI();
            showActionResult('Player protected! Waiting for next phase...');
            selectedPlayerId = null;
          } else {
            showActionResult(response.message, 'error');
          }
        });
      }

      selectedPlayerId = null;
      resetSeatStates();
    }

    function hideGameActionUI() {
      document.getElementById('actionControls').style.display = 'none';
      resetSeatStates();
    }

    function showActionResult(message, type = 'success') {
      const resultDiv = document.getElementById('actionResult');
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';

      if (type === 'error') {
        resultDiv.style.backgroundColor = '#f8d7da';
        resultDiv.style.color = '#721c24';
      } else {
        resultDiv.style.backgroundColor = '#d4edda';
        resultDiv.style.color = '#155724';
      }
    }

    function showGameStatus(phase, message, instructions = '') {
      const gameStatus = document.getElementById('gameStatus');
      const phaseInfo = document.getElementById('phaseInfo');
      const phaseInstructions = document.getElementById('phaseInstructions');

      gameStatus.style.display = 'block';
      gameStatus.className = `game-status ${phase}`;
      phaseInfo.textContent = message;
      phaseInstructions.textContent = instructions;

      // Update lobby title
      document.getElementById('lobbyTitle').textContent = message;
    }

    // Orphan Phase Event Listeners (before night starts)
    socket.on('orphanPhaseAudio', (data) => {
      currentPhase = 'orphan';
      showGameStatus('night', 'üë∂ Orphan Turn', 'Orphans, open your eyes and choose your father');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('orphanPhaseUI', (data) => {
      // Only orphans see this UI - show action controls
      setTimeout(() => {
        // Hide all previous phase buttons first
        hideAllPhaseButtons();

        document.getElementById('actionMessage').textContent = 'Choose a player to be your father:';
        document.getElementById('actionControls').style.display = 'block';

        // Make all eligible players' seats selectable for orphan
        data.players.forEach(player => {
          const seat = document.querySelector(`[data-seat="${player.seat}"]`);
          if (seat && seat.classList.contains('occupied')) {
            seat.classList.add('selectable');
            seat.setAttribute('data-player-id', player.id);
            seat.onclick = () => selectSeatForOrphan(player.seat, player.id);
          }
        });

      }, 2000); // Delay to let audio finish
    });

    // Function to handle orphan seat selection
    function selectSeatForOrphan(seatId, playerId) {
      const seat = document.querySelector(`[data-seat="${seatId}"]`);

      if (seat && seat.classList.contains('selectable')) {
        // Clear previous selections
        document.querySelectorAll('.seat').forEach(s => {
          s.classList.remove('selected');
        });

        // Select this seat
        seat.classList.add('selected');
        selectedPlayerId = playerId;

        // Show orphan-specific confirm button
        const orphanConfirmBtn = document.getElementById('orphanConfirmBtn') || createOrphanConfirmButton();
        orphanConfirmBtn.style.display = 'inline-block';
      }
    }

    // Create orphan confirm button if it doesn't exist
    function createOrphanConfirmButton() {
      const orphanConfirmBtn = document.createElement('button');
      orphanConfirmBtn.id = 'orphanConfirmBtn';
      orphanConfirmBtn.className = 'button success';
      orphanConfirmBtn.textContent = 'Confirm Father Selection';
      orphanConfirmBtn.onclick = confirmOrphanSelection;

      const actionControls = document.getElementById('actionControls');
      actionControls.appendChild(orphanConfirmBtn);

      return orphanConfirmBtn;
    }

    // Function to confirm orphan's father selection
    function confirmOrphanSelection() {
      if (!selectedPlayerId) {
        showActionResult('Please select a player to be your father', 'error');
        return;
      }

      socket.emit('orphanSelectFather', { roomId: currentRoom, fatherId: selectedPlayerId }, (response) => {
        if (response.success) {
          hideGameActionUI();
          showActionResult('Father selected! Waiting for other orphans or next phase...');
          selectedPlayerId = null;

          // Hide the orphan confirm button
          const orphanConfirmBtn = document.getElementById('orphanConfirmBtn');
          if (orphanConfirmBtn) {
            orphanConfirmBtn.style.display = 'none';
          }
        } else {
          showActionResult(response.message, 'error');
        }
      });
    }

    // Night Phase Event Listeners (modified for lobby-based UI)
    socket.on('nightPhaseStarted', (data) => {
      showGameStatus('night', 'üåô Night Time', 'Listen for instructions and close your eyes');
      hideGameActionUI();

      // Show host night status check button
      if (isHost) {
        document.getElementById('checkNightStatusBtn').style.display = 'inline-block';
      }

      // Play audio announcement
      speakText(data.message);
    });

    // Werewolf Phase - Lobby-based UI
    socket.on('werewolfPhaseAudio', (data) => {
      currentPhase = 'werewolf';
      showGameStatus('night', 'üê∫ Werewolves Turn', 'Werewolves, open your eyes and choose a player to kill');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('werewolfPhaseUI', (data) => {
      // Only werewolves see this UI - show action controls and make seats selectable
      setTimeout(() => {
        // Hide all previous phase buttons first
        hideAllPhaseButtons();

        document.getElementById('actionMessage').textContent = getText('choosePlayerToKill');
        document.getElementById('actionControls').style.display = 'block';

        // Make all occupied seats selectable for werewolves
        data.players.forEach(player => {
          const seat = document.querySelector(`[data-seat="${player.seat}"]`);
          if (seat && seat.classList.contains('occupied')) {
            seat.classList.add('selectable');
            // Store player ID in seat element for selection
            seat.setAttribute('data-player-id', player.id);
            // Override click handler for game phase
            seat.onclick = () => selectSeatForAction(player.seat, player.id);
          }
        });
      }, 2000); // Delay to let audio finish
    });

    // Function to handle seat selection during game phases
    function selectSeatForAction(seatId, playerId) {
      // Clear previous selections
      document.querySelectorAll('.seat').forEach(seat => {
        seat.classList.remove('selected');
      });

      // Select the clicked seat
      const seat = document.querySelector(`[data-seat="${seatId}"]`);
      if (seat && seat.classList.contains('selectable')) {
        seat.classList.add('selected');
        selectedPlayerId = playerId;
        document.getElementById('confirmSelection').style.display = 'inline-block';
      }
    }

    // Listen for werewolf UI hide event
    socket.on('hideWerewolfUI', () => {
      if (currentPhase === 'werewolf') {
        hideGameActionUI();
        showActionResult('Waiting for other actions...');
      }
    });

    // Cupid Phase Event Listeners
    socket.on('cupidPhaseAudio', (data) => {
      currentPhase = 'cupid';
      showGameStatus('night', 'üíò Cupid Turn', 'Cupid, open your eyes and choose two players to be lovers');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('cupidPhaseUI', (data) => {
      // Only cupid sees this UI - show action controls
      setTimeout(() => {
        // Hide all previous phase buttons first
        hideAllPhaseButtons();

        document.getElementById('actionMessage').textContent = 'Choose 2 players to become lovers:';
        document.getElementById('actionControls').style.display = 'block';

        // Make all occupied seats selectable for cupid
        data.players.forEach(player => {
          const seat = document.querySelector(`[data-seat="${player.seat}"]`);
          if (seat && seat.classList.contains('occupied')) {
            seat.classList.add('selectable');
            seat.setAttribute('data-player-id', player.id);
            seat.onclick = () => selectSeatForCupid(player.seat, player.id);
          }
        });

        // Create and show cupid confirm button
        const cupidConfirmBtn = document.createElement('button');
        cupidConfirmBtn.id = 'cupidConfirmBtn';
        cupidConfirmBtn.className = 'button success';
        cupidConfirmBtn.textContent = 'Confirm and Continue';
        cupidConfirmBtn.style.display = 'none';
        cupidConfirmBtn.onclick = confirmCupidSelection;

        const actionControls = document.getElementById('actionControls');
        actionControls.appendChild(cupidConfirmBtn);

      }, 2000); // Delay to let audio finish
    });

    // Function to handle cupid seat selection (allows multiple selections)
    function selectSeatForCupid(seatId, playerId) {
      const seat = document.querySelector(`[data-seat="${seatId}"]`);

      if (seat && seat.classList.contains('selectable')) {
        // Toggle selection
        if (seat.classList.contains('selected')) {
          // Deselect
          seat.classList.remove('selected');
          selectedPlayerIds = selectedPlayerIds.filter(id => id !== playerId);
        } else {
          // Select (max 2 players)
          if (selectedPlayerIds.length < 2) {
            seat.classList.add('selected');
            selectedPlayerIds.push(playerId);
          } else {
            showActionResult('You can only select 2 players as lovers', 'error');
            return;
          }
        }

        // Update confirmation button visibility
        const cupidConfirmBtn = document.getElementById('cupidConfirmBtn');
        if (selectedPlayerIds.length === 2) {
          cupidConfirmBtn.style.display = 'inline-block';
        } else {
          cupidConfirmBtn.style.display = 'none';
        }

        // Update action message
        document.getElementById('actionMessage').textContent =
          `Choose 2 players to become lovers: (${selectedPlayerIds.length}/2 selected)`;
      }
    }

    // Function to confirm cupid's lover selection
    function confirmCupidSelection() {
      if (selectedPlayerIds.length !== 2) {
        showActionResult('You must select exactly 2 players', 'error');
        return;
      }

      socket.emit('cupidSelect', { roomId: currentRoom, targetIds: selectedPlayerIds }, (response) => {
        if (response.success) {
          hideGameActionUI();
          showActionResult('Lovers selected! Waiting for next phase...');
          selectedPlayerIds = [];
        } else {
          showActionResult(response.message, 'error');
        }
      });
    }

    // Listen for lovers reveal phase
    socket.on('loversRevealPhase', (data) => {
      showGameStatus('night', 'üíï Lovers Reveal', data.message);
      speakText(data.message);
    });

    // Handle lover assignment
    socket.on('loverAssigned', (data) => {
      if (data.isLover) {
        isLover = true;
        partnerName = data.partnerName;

        // Show lover notification to the assigned player
        showActionResult(`üíï You are now a lover! Your partner is: ${partnerName}`, 'success');

        // You could also update the UI to show lover status permanently
        const roleStatusElement = document.getElementById('roleStatusText');
        if (roleStatusElement) {
          roleStatusElement.innerHTML += ` üíï (Lover: ${partnerName})`;
        }
      }
    });

    // Guard Phase Event Listeners
    socket.on('guardPhaseAudio', (data) => {
      currentPhase = 'guard';
      showGameStatus('night', 'üõ°Ô∏è Guard Turn', 'Guard, open your eyes and choose a player to protect');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('guardPhaseUI', (data) => {
      // Only guard sees this UI - show action controls
      setTimeout(() => {
        // Hide all previous phase buttons first
        hideAllPhaseButtons();

        document.getElementById('actionMessage').textContent = 'Choose a player to protect:';
        document.getElementById('actionControls').style.display = 'block';

        // Make all occupied seats selectable for guard
        data.players.forEach(player => {
          const seat = document.querySelector(`[data-seat="${player.seat}"]`);
          if (seat && seat.classList.contains('occupied')) {
            seat.classList.add('selectable');
            seat.setAttribute('data-player-id', player.id);
            seat.onclick = () => selectSeatForAction(player.seat, player.id);
          }
        });

        // Show confirmation button (reuse existing one)
        document.getElementById('confirmSelection').style.display = 'inline-block';

      }, 2000); // Delay to let audio finish
    });

    // Function to handle guard's protection selection
    function confirmGuardSelection() {
      if (!selectedPlayerId) {
        showActionResult('Please select a player to protect', 'error');
        return;
      }

      socket.emit('guardProtect', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
        if (response.success) {
          hideGameActionUI();
          showActionResult('Player protected! Waiting for next phase...');
          selectedPlayerId = null;
        } else {
          showActionResult(response.message, 'error');
        }
      });
    }

    // Witch Phase - Lobby-based UI
    socket.on('witchPhaseAudio', (data) => {
      currentPhase = 'witch';
      showGameStatus('night', 'üßô‚Äç‚ôÄÔ∏è Witch Turn', 'Witch, open your eyes');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('witchPhaseUI', (data) => {
      // Store current players data for witch actions
      currentPlayers = data.players;

      // Only witch sees this UI - show lobby-based action controls
      setTimeout(() => {
        let actionMessage = getText('witchActions');
        if (data.killedPlayer) {
          const killedPlayerName = data.players.find(p => p.id === data.killedPlayer)?.name || 'Unknown';
          actionMessage += ` ${killedPlayerName} ${getText('wasKilledSaveThem')}`;
        }
        document.getElementById('actionMessage').textContent = actionMessage;
        document.getElementById('actionControls').style.display = 'block';

        // Show witch-specific buttons
        if (data.killedPlayer) {
          document.getElementById('witchSaveBtn').style.display = 'inline-block';
        }
        document.getElementById('witchPoisonBtn').style.display = 'inline-block';
        document.getElementById('witchSkipBtn').style.display = 'inline-block';
      }, 2000); // Delay to let audio finish
    });

    // Seer Phase - Lobby-based UI
    socket.on('seerPhaseAudio', (data) => {
      currentPhase = 'seer';
      showGameStatus('night', 'üîÆ Seer Turn', 'Seer, open your eyes and choose a player to check');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('seerPhaseUI', (data) => {
      // Only seer sees this UI - show lobby-based action controls
      setTimeout(() => {
        // Hide all previous phase buttons first
        hideAllPhaseButtons();

        document.getElementById('actionMessage').textContent = getText('choosePlayerToCheck');
        document.getElementById('actionControls').style.display = 'block';

        // Make all occupied seats selectable for seer to check
        data.players.forEach(player => {
          const seat = document.querySelector(`[data-seat="${player.seat}"]`);
          if (seat && seat.classList.contains('occupied')) {
            seat.classList.add('selectable');
            seat.setAttribute('data-player-id', player.id);
            seat.onclick = () => selectSeatForAction(player.seat, player.id);
          }
        });
      }, 2000); // Delay to let audio finish
    });

    // Helper function to hide all phase-specific buttons
    function hideAllPhaseButtons() {
      // Hide cupid buttons
      document.getElementById('cupidConfirmBtn') && (document.getElementById('cupidConfirmBtn').style.display = 'none');

      // Hide witch buttons
      document.getElementById('witchSaveBtn').style.display = 'none';
      document.getElementById('witchPoisonBtn').style.display = 'none';
      document.getElementById('witchSkipBtn').style.display = 'none';

      // Hide seer buttons
      document.getElementById('seerContinueBtn').style.display = 'none';

      // Hide confirm selection button
      document.getElementById('confirmSelection').style.display = 'none';

      // Hide action result
      document.getElementById('actionResult').style.display = 'none';
    }

    // Seer result handling
    socket.on('seerResult', (data) => {
      // Show the result to the seer
      showActionResult(`${data.targetName} is a <strong>${data.result}</strong>`);

      // Show the dedicated seer continue button
      document.getElementById('seerContinueBtn').style.display = 'inline-block';

      // Seer result is shown silently (no audio) so other players don't hear
    });

    // Function for seer to continue after seeing result
    function seerContinue() {
      socket.emit('seerComplete', { roomId: currentRoom });
      hideGameActionUI();
      document.getElementById('seerContinueBtn').style.display = 'none';
    }

    // Function for hunter to continue after seeing their status
    function hunterContinue() {
      socket.emit('hunterComplete', { roomId: currentRoom });
      hideGameActionUI();
      document.getElementById('hunterContinueBtn').style.display = 'none';
    }

    socket.on('phaseComplete', (data) => {
      showGameStatus('night', 'üëÅÔ∏è Close Your Eyes', data.message);
      hideGameActionUI();

      // Play audio for phase completion
      speakText(data.message);
    });

    // Detector Election Phase Event Listener
    socket.on('detectorElectionPhase', (data) => {
      showGameStatus('day', 'üïµÔ∏è Detector Election', data.message);
      hideGameActionUI();

      // Play audio for detector election announcement
      speakText(data.message);
    });

    // Hunter Phase Event Listeners
    socket.on('hunterPhaseAudio', (data) => {
      currentPhase = 'hunter';
      showGameStatus('night', 'üèπ Hunter Turn', 'Hunter, open your eyes');
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('hunterPhaseUI', (data) => {
      // Only hunters see this UI - show them their status
      setTimeout(() => {
        // Hide all previous phase buttons first
        hideAllPhaseButtons();

        document.getElementById('actionMessage').textContent = data.isPoisoned ?
          getText('poisonNotification') : 'Hunter Status';
        document.getElementById('actionControls').style.display = 'block';

        // Show the message in the action result area
        const resultDiv = document.getElementById('actionResult');
        resultDiv.innerHTML = data.message;
        resultDiv.style.display = 'block';

        if (data.isPoisoned) {
          resultDiv.style.backgroundColor = '#f8d7da';
          resultDiv.style.color = '#721c24';
        } else {
          resultDiv.style.backgroundColor = '#d4edda';
          resultDiv.style.color = '#155724';
        }

        // Show hunter continue button
        document.getElementById('hunterContinueBtn').style.display = 'inline-block';
      }, 2000); // Delay to let audio finish
    });

    socket.on('dayPhaseStarted', (data) => {
      document.getElementById('phaseMessage').textContent = data.message;
      document.getElementById('currentPhase').className = 'day-phase';
      hideActionArea();

      // Show host controls for checking last night
      if (isHost) {
        document.getElementById('hostControls').classList.remove('hidden');
      }

      // Show deaths if any
      if (data.deaths && data.deaths.length > 0) {
        // You can add death announcements here
      }
    });

    // Add event listeners for role input validation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('numWerewolves').addEventListener('input', updateRoleInputs);
      document.getElementById('numOrphans').addEventListener('input', updateRoleInputs);
      document.querySelectorAll('.special-wolves input').forEach(checkbox => {
        checkbox.addEventListener('change', updateRoleInputs);
      });
      document.querySelectorAll('.special-roles input').forEach(checkbox => {
        checkbox.addEventListener('change', updateRoleInputs);
      });
    });

    // View Orphan Map functionality
    function viewOrphanMap() {
      if (!currentRoom) {
        alert('You must be in a game to view the orphan map');
        return;
      }

      // Show confirmation dialog
      if (!confirm('Do you really want to see the orphan-father map? Only click when you are game coordinator.')) {
        return;
      }

      // Request orphan map from server
      socket.emit('getOrphanMap', { roomId: currentRoom }, (response) => {
        if (response.success) {
          const chains = response.chains;
          displayOrphanMap(chains);
        } else {
          alert(response.message || 'Failed to load orphan map');
        }
      });
    }

    // Display orphan map with graph visualization
    function displayOrphanMap(chains) {
      if (!chains || chains.length === 0) {
        alert('No orphan-father relationships recorded yet');
        return;
      }

      // Format display text
      let displayText = 'üë∂ Orphan-Father Map\n\n';
      displayText += '‚ïê'.repeat(50) + '\n\n';

      chains.forEach((chain, index) => {
        displayText += `Chain ${index + 1}: ${chain.hasLoop ? '‚ö†Ô∏è ' : ''}${chain.text}\n\n`;
      });

      alert(displayText);
    }

    // Check for existing session when page loads
    window.addEventListener('load', () => {
      checkForExistingSession();
    });
  </script>
</body>

</html>
