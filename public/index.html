<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolves Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .page {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .page.active {
      display: block;
    }

    .config-form {
      max-width: 500px;
    }

    .config-form input,
    .config-form select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .special-roles {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 10px 0;
    }

    .special-roles label {
      display: flex;
      align-items: center;
    }

    .special-roles input {
      width: auto;
      margin-right: 8px;
    }

    .seating-area {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      max-width: 1000px;
      margin: 20px 0;
    }

    .seat {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .seat:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .seat.occupied {
      background-color: #28a745;
      color: white;
      cursor: not-allowed;
    }

    .seat.occupied:hover {
      background-color: #28a745;
    }

    .seat-number {
      font-weight: bold;
      font-size: 18px;
    }

    .seat-player {
      font-size: 14px;
      margin-top: 5px;
    }

    .button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .button:hover {
      background-color: #0056b3;
    }

    .button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .button.success {
      background-color: #28a745;
    }

    .button.success:hover {
      background-color: #218838;
    }

    .status {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .role-display {
      text-align: center;
      padding: 40px;
    }

    .role-name {
      font-size: 36px;
      font-weight: bold;
      color: #007bff;
      margin: 20px 0;
    }

    .error {
      color: #dc3545;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .role-status {
      color: #6c757d;
    }

    .role-status.assigned {
      color: #28a745;
    }

    .game-page {
      text-align: center;
      padding: 20px;
    }

    .night-phase {
      background-color: #1a1a2e;
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .day-phase {
      background-color: #f8f9fa;
      color: #333;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .phase-message {
      font-size: 24px;
      font-weight: bold;
      margin: 20px 0;
    }

    .action-area {
      margin: 20px 0;
    }

    .player-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .player-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      color: #333;
    }

    .player-card:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .player-card.selected {
      border-color: #28a745;
      background-color: #d4edda;
    }

    .player-card.dead {
      background-color: #f8d7da;
      border-color: #dc3545;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .action-buttons {
      margin: 20px 0;
    }

    .action-buttons .button {
      margin: 0 10px;
    }

    .result-display {
      background-color: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Landing Page -->
  <div id="landing" class="page active">
    <h1>üê∫ Werewolves Game</h1>

    <div style="margin: 20px 0;">
      <h3>Join Game</h3>
      <input id="playerName" type="text" placeholder="Enter your name" maxlength="20">
      <input id="roomCode" type="text" placeholder="Enter room code" maxlength="6">
      <button class="button" onclick="joinGame()">Join Game</button>
    </div>

    <div style="margin: 20px 0;">
      <h3>Host Game</h3>
      <button class="button success" onclick="showConfigPage()">Configure & Create Game</button>
    </div>

    <div id="landingMessage"></div>
  </div>

  <!-- Configuration Page (Host Only) -->
  <div id="configure" class="page">
    <h2>‚öôÔ∏è Game Configuration</h2>

    <form class="config-form" onsubmit="configureGame(event)">
      <label>Game Language:</label>
      <select id="gameLanguage">
        <option value="en">English</option>
        <option value="zh">‰∏≠Êñá (Chinese)</option>
      </select>

      <label>Total Players:</label>
      <select id="totalPlayers" onchange="updateRoleInputs()">
        <option value="6">6 Players</option>
        <option value="7">7 Players</option>
        <option value="8">8 Players</option>
        <option value="9">9 Players</option>
        <option value="10">10 Players</option>
        <option value="11">11 Players</option>
        <option value="12" selected>12 Players</option>
        <option value="13">13 Players</option>
        <option value="14">14 Players</option>
        <option value="15">15 Players</option>
        <option value="16">16 Players</option>
      </select>

      <label>Number of Werewolves:</label>
      <input id="numWerewolves" type="number" min="1" max="4" value="3">

      <label>Number of Villagers:</label>
      <input id="numVillagers" type="number" min="1" max="8" value="6">

      <label>Special Roles:</label>
      <div class="special-roles">
        <label><input type="checkbox" value="seer"> üîÆ Seer</label>
        <label><input type="checkbox" value="witch"> üßô‚Äç‚ôÄÔ∏è Witch</label>
        <label><input type="checkbox" value="hunter"> üèπ Hunter</label>
        <label><input type="checkbox" value="fool"> üÉè Fool</label>
        <label><input type="checkbox" value="guard"> üõ°Ô∏è Guard</label>
        <label><input type="checkbox" value="cupid"> üíò Cupid</label>
      </div>

      <div id="roleValidation" class="error" style="display: none;"></div>

      <button type="submit" class="button success">Create Room</button>
      <button type="button" class="button" onclick="showLandingPage()">Back</button>
    </form>
  </div>

  <!-- Game Lobby -->
  <div id="lobby" class="page">
    <h2>üè† Game Lobby</h2>

    <div id="gameInfo" class="status">
      <div><strong>Room Code:</strong> <span id="displayRoomCode"></span></div>
      <div><strong>Total Players:</strong> <span id="displayTotalPlayers"></span></div>
      <div><strong>Seated Players:</strong> <span id="seatedCount">0</span> / <span id="totalPlayerCount">0</span></div>
      <div><strong>Roles:</strong> <span id="roleStatusText" class="role-status">Not assigned</span></div>
    </div>

    <h3>Choose Your Seat</h3>
    <div id="seatingArea" class="seating-area">
      <!-- Seats will be dynamically generated -->
    </div>

    <div id="gameControls">
      <button id="startGameBtn" class="button success" onclick="startGame()" disabled>Start Game</button>
      <button id="seeRoleBtn" class="button" onclick="showRolePage()" style="display: none;">See Your Role</button>
      <button class="button" onclick="showLandingPage()">Leave Game</button>
    </div>

    <div id="lobbyMessage"></div>
  </div>

  <!-- Role Page -->
  <div id="role" class="page">
    <div class="role-display">
      <h2>üé≠ Your Role</h2>
      <div class="role-name" id="roleDisplay">Loading...</div>
      <div id="roleDescription"></div>
      <button class="button" onclick="showLobbyPage()">Back to Game</button>
    </div>
  </div>

  <!-- Game Page -->
  <div id="game" class="page">
    <div class="game-page">
      <h2>üéÆ Game in Progress</h2>

      <!-- Current Phase Display -->
      <div id="currentPhase" class="night-phase">
        <div class="phase-message" id="phaseMessage">Game Starting...</div>
      </div>

      <!-- Action Area (shown only to relevant roles during their turn) -->
      <div id="actionArea" class="action-area hidden">
        <!-- Player Selection -->
        <div id="playerSelection" class="hidden">
          <h3 id="actionTitle">Choose a player:</h3>
          <div id="playerList" class="player-list">
            <!-- Players will be populated dynamically -->
          </div>
        </div>

        <!-- Action Buttons -->
        <div id="actionButtons" class="action-buttons hidden">
          <button id="confirmBtn" class="button success" onclick="confirmAction()">Confirm</button>
          <button id="saveBtn" class="button" onclick="witchSave()" style="display: none;">Save Player</button>
          <button id="poisonBtn" class="button" onclick="witchPoison()" style="display: none;">Use Poison</button>
          <button id="skipBtn" class="button" onclick="skipAction()" style="display: none;">Skip</button>
          <button id="completeBtn" class="button" onclick="completeWitchAction()"
            style="display: none;">Complete</button>
        </div>

        <!-- Result Display -->
        <div id="resultDisplay" class="result-display hidden">
          <!-- Results will be shown here -->
        </div>
      </div>

      <!-- Host Controls (Day Phase) -->
      <div id="hostControls" class="hidden">
        <button id="checkNightBtn" class="button" onclick="checkLastNight()">Check Last Night Status</button>
      </div>

      <!-- Navigation -->
      <div style="margin-top: 30px;">
        <button class="button" onclick="showRolePage()">See My Role</button>
        <button class="button" onclick="showLobbyPage()">Back to Lobby</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null;
    let isHost = false;
    let currentRole = null;
    let pendingSeats = null; // Store seats data if received before seating area is created

    // Role descriptions
    const roleDescriptions = {
      'werewolf': 'üê∫ You are a Werewolf! Work with other werewolves to eliminate villagers during the night.',
      'villager': 'üë®‚Äçüåæ You are a Villager! Find and eliminate the werewolves during the day.',
      'seer': 'üîÆ You are the Seer! You can check one player\'s role each night.',
      'witch': 'üßô‚Äç‚ôÄÔ∏è You are the Witch! You have a healing potion and a poison potion.',
      'hunter': 'üèπ You are the Hunter! When you die, you can choose to eliminate another player.',
      'fool': 'üÉè You are the Fool! You win if the villagers mistakenly vote you out.',
      'guard': 'üõ°Ô∏è You are the Guard! You can protect one player each night.',
      'cupid': 'üíò You are Cupid! On the first night, you choose two players to fall in love.'
    };

    // Page Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    function showLandingPage() {
      showPage('landing');
      if (currentRoom) {
        socket.disconnect();
        socket.connect();
        currentRoom = null;
        isHost = false;
      }
    }

    function showConfigPage() {
      showPage('configure');
      updateRoleInputs();
    }

    function showLobbyPage() {
      showPage('lobby');
    }

    function showRolePage() {
      showPage('role');
      socket.emit('getMyRole', currentRoom, (response) => {
        if (response.success) {
          currentRole = response.role;
          document.getElementById('roleDisplay').textContent = response.role.toUpperCase();
          document.getElementById('roleDescription').textContent = roleDescriptions[response.role] || '';
        }
      });
    }

    // Configuration
    function updateRoleInputs() {
      const totalPlayers = parseInt(document.getElementById('totalPlayers').value);
      const werewolvesInput = document.getElementById('numWerewolves');
      const villagersInput = document.getElementById('numVillagers');

      // Update max values
      werewolvesInput.max = Math.floor(totalPlayers / 3);
      villagersInput.max = totalPlayers - 1;

      // Auto-update villagers count
      const werewolves = parseInt(werewolvesInput.value) || 0;
      const specialRoles = document.querySelectorAll('.special-roles input:checked').length;
      villagersInput.value = Math.max(1, totalPlayers - werewolves - specialRoles);
    }

    function validateConfiguration() {
      const totalPlayers = parseInt(document.getElementById('totalPlayers').value);
      const werewolves = parseInt(document.getElementById('numWerewolves').value);
      const villagers = parseInt(document.getElementById('numVillagers').value);
      const specialRoles = document.querySelectorAll('.special-roles input:checked').length;

      const totalRoles = werewolves + villagers + specialRoles;

      if (totalRoles !== totalPlayers) {
        document.getElementById('roleValidation').textContent =
          `Total roles (${totalRoles}) must equal total players (${totalPlayers})`;
        document.getElementById('roleValidation').style.display = 'block';
        return false;
      }

      document.getElementById('roleValidation').style.display = 'none';
      return true;
    }

    function configureGame(event) {
      event.preventDefault();

      if (!validateConfiguration()) {
        return;
      }

      const config = {
        language: document.getElementById('gameLanguage').value,
        totalPlayers: parseInt(document.getElementById('totalPlayers').value),
        numWerewolves: parseInt(document.getElementById('numWerewolves').value),
        numVillagers: parseInt(document.getElementById('numVillagers').value),
        specialRoles: Array.from(document.querySelectorAll('.special-roles input:checked')).map(cb => cb.value)
      };

      socket.emit('configureGame', config, (response) => {
        if (response.success) {
          // Ask for host name
          const hostName = prompt('Enter your name:');
          if (!hostName) return;

          socket.emit('createGame', (response) => {
            if (response.success) {
              currentRoom = response.roomId;
              isHost = true;

              // Join the room as host
              socket.emit('joinGame', { roomId: currentRoom, name: hostName }, (joinResponse) => {
                if (joinResponse.success) {
                  showLobbyPage();
                  document.getElementById('displayRoomCode').textContent = currentRoom;
                } else {
                  showMessage('landingMessage', joinResponse.message, 'error');
                }
              });
            } else {
              showMessage('landingMessage', response.message, 'error');
            }
          });
        } else {
          showMessage('landingMessage', response.message, 'error');
        }
      });
    }

    // Join Game
    function joinGame() {
      const name = document.getElementById('playerName').value.trim();
      const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();

      if (!name) {
        showMessage('landingMessage', 'Please enter your name', 'error');
        return;
      }

      if (!roomCode) {
        showMessage('landingMessage', 'Please enter room code', 'error');
        return;
      }

      socket.emit('joinGame', { roomId: roomCode, name }, (response) => {
        if (response.success) {
          currentRoom = roomCode;
          isHost = response.isHost;
          showLobbyPage();
          document.getElementById('displayRoomCode').textContent = roomCode;
          showMessage('lobbyMessage', response.message, 'success');
        } else {
          showMessage('landingMessage', response.message, 'error');
        }
      });
    }

    // Seating
    function createSeatingArea(totalPlayers) {
      const seatingArea = document.getElementById('seatingArea');
      seatingArea.innerHTML = '';

      for (let i = 1; i <= totalPlayers; i++) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.setAttribute('data-seat', i);
        seat.innerHTML = `
          <div class="seat-number">Seat ${i}</div>
          <div class="seat-player" id="seat-${i}-player"></div>
        `;

        seat.onclick = () => chooseSeat(i);
        seatingArea.appendChild(seat);
      }
    }

    function chooseSeat(seatId) {
      socket.emit('chooseSeat', { roomId: currentRoom, seatId }, (response) => {
        if (response.success) {
          showMessage('lobbyMessage', response.message, 'success');
        } else {
          showMessage('lobbyMessage', response.message, 'error');
        }
      });
    }

    function updateSeats(seats) {
      seats.forEach(seat => {
        const seatElement = document.querySelector(`[data-seat="${seat.id}"]`);
        const playerElement = document.getElementById(`seat-${seat.id}-player`);

        if (seat.player) {
          seatElement.classList.add('occupied');
          playerElement.textContent = seat.player.name;
          seatElement.onclick = null; // Remove click handler
        } else {
          seatElement.classList.remove('occupied');
          playerElement.textContent = '';
          seatElement.onclick = () => chooseSeat(seat.id);
        }
      });
    }

    // Game Controls
    function startGame() {
      socket.emit('startGame', currentRoom, (response) => {
        if (response.success) {
          showMessage('lobbyMessage', response.message, 'success');
        } else {
          showMessage('lobbyMessage', response.message, 'error');
        }
      });
    }

    // Utility Functions
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => {
        element.innerHTML = '';
      }, 5000);
    }

    // Socket Event Listeners
    socket.on('gameConfig', (config) => {
      document.getElementById('displayTotalPlayers').textContent = config.totalPlayers;
      document.getElementById('totalPlayerCount').textContent = config.totalPlayers;
      createSeatingArea(config.totalPlayers);

      // Store the game language for audio
      gameLanguage = config.language || 'en';

      // If we received seats data before the seating area was created, apply it now
      if (pendingSeats) {
        updateSeats(pendingSeats);
        pendingSeats = null;
      }
    });

    socket.on('updateSeats', (seats) => {
      // Check if seating area exists, if not, store the seats data
      const seatingArea = document.getElementById('seatingArea');
      if (seatingArea && seatingArea.children.length > 0) {
        updateSeats(seats);
      } else {
        pendingSeats = seats;
      }
    });

    // Updated to handle roles being assigned before game starts
    socket.on('seatsStatus', (status) => {
      document.getElementById('seatedCount').textContent = status.filled;

      if (isHost) {
        // Enable start game button only when all seats filled AND roles assigned
        document.getElementById('startGameBtn').disabled = !(status.allFilled && status.rolesAssigned);
      }
    });

    // Show role button as soon as role is assigned (before game starts)
    socket.on('roleAssigned', (role) => {
      currentRole = role;
      document.getElementById('seeRoleBtn').style.display = 'inline-block';
      showMessage('lobbyMessage', 'Your role has been assigned! Click "See Your Role" to view it.', 'success');
    });

    // Notify all players when roles are assigned
    socket.on('rolesAssigned', (data) => {
      document.getElementById('roleStatusText').textContent = 'Assigned ‚úÖ';
      document.getElementById('roleStatusText').className = 'role-status assigned';
      showMessage('lobbyMessage', data.message, 'success');
    });

    socket.on('gameStarted', (data) => {
      showMessage('lobbyMessage', `Game officially started! Phase: ${data.phase}`, 'success');
      // You can add additional game phase UI updates here
    });

    socket.on('hostDisconnected', () => {
      showMessage('lobbyMessage', 'Host disconnected. Game ended.', 'error');
      setTimeout(() => {
        showLandingPage();
      }, 3000);
    });

    // Game Phase Variables
    let selectedPlayerId = null;
    let currentPhase = null;
    let witchActions = { saved: false, poisoned: false };
    let gameLanguage = 'en'; // Default to English

    // Audio/Speech functionality
    let speechSynthesis = window.speechSynthesis;
    let isSpeaking = false;

    function speakText(text, callback) {
      if (!speechSynthesis) {
        console.log('Speech synthesis not supported');
        if (callback) callback();
        return;
      }

      // Cancel any ongoing speech
      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.8; // Slightly slower for clarity
      utterance.pitch = 1.0;
      utterance.volume = 1.0;

      // Set language based on game configuration
      utterance.lang = gameLanguage === 'zh' ? 'zh-CN' : 'en-US';

      utterance.onstart = () => {
        isSpeaking = true;
      };

      utterance.onend = () => {
        isSpeaking = false;
        if (callback) {
          setTimeout(callback, 500); // Small delay after speech
        }
      };

      utterance.onerror = () => {
        isSpeaking = false;
        if (callback) callback();
      };

      speechSynthesis.speak(utterance);
    }

    function stopSpeech() {
      if (speechSynthesis) {
        speechSynthesis.cancel();
        isSpeaking = false;
      }
    }

    // Game Phase Functions
    function showGamePage() {
      showPage('game');
    }

    function createPlayerList(players) {
      const playerList = document.getElementById('playerList');
      playerList.innerHTML = '';

      players.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.setAttribute('data-player', player.id);
        playerCard.innerHTML = `
          <div><strong>Seat ${player.seat}</strong></div>
          <div>${player.name}</div>
        `;

        playerCard.onclick = () => selectPlayer(player.id, playerCard);
        playerList.appendChild(playerCard);
      });
    }

    function selectPlayer(playerId, cardElement) {
      // Clear previous selection
      document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('selected');
      });

      // Select new player
      cardElement.classList.add('selected');
      selectedPlayerId = playerId;

      // Show confirm button
      document.getElementById('confirmBtn').style.display = 'inline-block';
    }

    function confirmAction() {
      if (!selectedPlayerId) return;

      if (currentPhase === 'werewolf') {
        socket.emit('werewolfKill', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            hideActionArea();
            showMessage('phaseMessage', response.message + ' - Werewolves, close your eyes', 'success');
          }
        });
      } else if (currentPhase === 'seer') {
        socket.emit('seerCheck', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
          if (response.success) {
            document.getElementById('confirmBtn').style.display = 'none';
          }
        });
      }

      selectedPlayerId = null;
    }

    function witchSave() {
      socket.emit('witchSave', { roomId: currentRoom }, (response) => {
        if (response.success) {
          witchActions.saved = true;
          document.getElementById('saveBtn').style.display = 'none';
          document.getElementById('resultDisplay').innerHTML = 'Player saved!';
          document.getElementById('resultDisplay').classList.remove('hidden');
        }
      });
    }

    function witchPoison() {
      if (!selectedPlayerId) {
        alert('Please select a player to poison');
        return;
      }

      socket.emit('witchPoison', { roomId: currentRoom, targetId: selectedPlayerId }, (response) => {
        if (response.success) {
          witchActions.poisoned = true;
          document.getElementById('poisonBtn').style.display = 'none';
          document.getElementById('resultDisplay').innerHTML = 'Player poisoned!';
          document.getElementById('resultDisplay').classList.remove('hidden');
        }
      });
    }

    function completeWitchAction() {
      socket.emit('witchComplete', { roomId: currentRoom }, (response) => {
        if (response.success) {
          hideActionArea();
        }
      });
    }

    function skipAction() {
      if (currentPhase === 'witch') {
        completeWitchAction();
      }
    }

    function checkLastNight() {
      socket.emit('checkLastNight', { roomId: currentRoom }, (response) => {
        if (response.success) {
          alert(response.message);
        }
      });
    }

    function hideActionArea() {
      document.getElementById('actionArea').classList.add('hidden');
      document.getElementById('playerSelection').classList.add('hidden');
      document.getElementById('actionButtons').classList.add('hidden');
      document.getElementById('resultDisplay').classList.add('hidden');

      // Reset buttons
      document.getElementById('confirmBtn').style.display = 'none';
      document.getElementById('saveBtn').style.display = 'none';
      document.getElementById('poisonBtn').style.display = 'none';
      document.getElementById('skipBtn').style.display = 'none';
      document.getElementById('completeBtn').style.display = 'none';

      selectedPlayerId = null;
    }

    // Night Phase Event Listeners (with Audio)
    socket.on('nightPhaseStarted', (data) => {
      showGamePage();
      document.getElementById('phaseMessage').textContent = 'üåô Night Time - Listen for Instructions';
      document.getElementById('currentPhase').className = 'night-phase';
      hideActionArea();
      document.getElementById('hostControls').classList.add('hidden');

      // Play audio announcement
      speakText(data.message);
    });

    // Werewolf Phase - Separated audio and UI
    socket.on('werewolfPhaseAudio', (data) => {
      currentPhase = 'werewolf';
      document.getElementById('phaseMessage').textContent = 'üê∫ Werewolves Turn';
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('werewolfPhaseUI', (data) => {
      // Only werewolves see this UI
      setTimeout(() => {
        document.getElementById('actionTitle').textContent = 'Choose a player to kill:';
        createPlayerList(data.players);
        document.getElementById('actionArea').classList.remove('hidden');
        document.getElementById('playerSelection').classList.remove('hidden');
        document.getElementById('actionButtons').classList.remove('hidden');
        document.getElementById('confirmBtn').style.display = 'none'; // Will show when player selected
      }, 2000); // Delay to let audio finish
    });

    // Witch Phase - Separated audio and UI
    socket.on('witchPhaseAudio', (data) => {
      currentPhase = 'witch';
      document.getElementById('phaseMessage').textContent = 'üßô‚Äç‚ôÄÔ∏è Witch Turn';
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('witchPhaseUI', (data) => {
      // Only witch sees this UI
      setTimeout(() => {
        let actionTitle = 'Witch actions:';
        if (data.killedPlayer) {
          const killedPlayerName = data.players.find(p => p.id === data.killedPlayer)?.name || 'Unknown';
          actionTitle += ` ${killedPlayerName} was killed. Save them?`;
        }
        document.getElementById('actionTitle').textContent = actionTitle;

        createPlayerList(data.players);
        document.getElementById('actionArea').classList.remove('hidden');
        document.getElementById('playerSelection').classList.remove('hidden');
        document.getElementById('actionButtons').classList.remove('hidden');

        // Show witch-specific buttons
        if (data.killedPlayer) {
          document.getElementById('saveBtn').style.display = 'inline-block';
        }
        document.getElementById('poisonBtn').style.display = 'inline-block';
        document.getElementById('skipBtn').style.display = 'inline-block';
        document.getElementById('completeBtn').style.display = 'inline-block';
        document.getElementById('confirmBtn').style.display = 'none';
      }, 2000); // Delay to let audio finish
    });

    // Seer Phase - Separated audio and UI
    socket.on('seerPhaseAudio', (data) => {
      currentPhase = 'seer';
      document.getElementById('phaseMessage').textContent = 'üîÆ Seer Turn';
      // Everyone hears this audio
      speakText(data.message);
    });

    socket.on('seerPhaseUI', (data) => {
      // Only seer sees this UI
      setTimeout(() => {
        document.getElementById('actionTitle').textContent = 'Choose a player to check:';
        createPlayerList(data.players);
        document.getElementById('actionArea').classList.remove('hidden');
        document.getElementById('playerSelection').classList.remove('hidden');
        document.getElementById('actionButtons').classList.remove('hidden');
        document.getElementById('confirmBtn').style.display = 'none'; // Will show when player selected
      }, 2000); // Delay to let audio finish
    });

    socket.on('seerResult', (data) => {
      document.getElementById('resultDisplay').innerHTML =
        `${data.targetName} is a <strong>${data.result}</strong>`;
      document.getElementById('resultDisplay').classList.remove('hidden');

      // Seer result is shown silently (no audio) so other players don't hear
    });

    socket.on('phaseComplete', (data) => {
      document.getElementById('phaseMessage').textContent = 'üëÅÔ∏è Close Your Eyes';
      hideActionArea();

      // Play audio for phase completion
      speakText(data.message);
    });

    socket.on('dayPhaseStarted', (data) => {
      document.getElementById('phaseMessage').textContent = data.message;
      document.getElementById('currentPhase').className = 'day-phase';
      hideActionArea();

      // Show host controls for checking last night
      if (isHost) {
        document.getElementById('hostControls').classList.remove('hidden');
      }

      // Show deaths if any
      if (data.deaths && data.deaths.length > 0) {
        // You can add death announcements here
      }
    });

    // Add event listeners for role input validation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('numWerewolves').addEventListener('input', updateRoleInputs);
      document.querySelectorAll('.special-roles input').forEach(checkbox => {
        checkbox.addEventListener('change', updateRoleInputs);
      });
    });
  </script>
</body>

</html>
